<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Case Manager 2025</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet"/>
<style>
    /* --- CUSTOM DESIGN SYSTEM --- */
    :root {
      --primary-color: #4f46e5;
      --primary-hover: #4338ca;
      --sidebar-bg: #111827;
      --sidebar-link: #9ca3af;
      --sidebar-link-active: #ffffff;
      --sidebar-link-active-bg: #374151;
      --content-bg: #f3f4f6;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --card-bg: #ffffff;
    }

    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      background-color: var(--content-bg);
      color: var(--text-primary);
    }

    /* --- SIDEBAR --- */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 0.5rem;
      background: var(--sidebar-bg);
      border-right: none;
      transition: transform 0.3s ease-in-out;
      z-index: 1000;
    }
    .sidebar .sidebar-header {
      color: #fff;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .sidebar .nav-link {
      color: var(--sidebar-link);
      font-size: 0.95rem;
      padding: 0.75rem 1.25rem;
      border-radius: 6px;
      margin-bottom: 0.25rem;
      font-weight: 500;
      transition: color 0.2s, background-color 0.2s;
    }
    .sidebar .nav-link:hover {
      background: var(--sidebar-link-active-bg);
      color: var(--sidebar-link-active);
    }
    .sidebar .nav-link.active {
      background: var(--primary-color);
      color: var(--sidebar-link-active);
    }
    .sidebar .nav-link i.fa-fw {
      width: 20px;
      text-align: center;
    }

    /* Sidebar Filters */
    .sidebar .filters { padding: 1.25rem; }
    .sidebar .filters .h6 { color: #6b7280; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
    .sidebar .filters .form-label { color: var(--sidebar-link); font-size: 0.85rem; }
    .sidebar .filters .form-select { background-color: #374151; color: #fff; border-color: #4b5563; }
    .sidebar .filters .form-select:focus { box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4); }

    /* --- MAIN CONTENT --- */
    .main-content { 
      padding: 2rem !important; 
      margin-left: 250px;
    }
    .main-title { font-weight: 700; color: var(--text-primary); }

    /* --- CARDS --- */
    .card {
      background-color: var(--card-bg);
      border: none;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      border-radius: 0.75rem;
    }
    .card-header {
      background-color: transparent;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      padding: 1rem 1.25rem;
    }

    /* Stat Cards */
    .card-stats .card-body { display: flex; justify-content: space-between; align-items: center; }
    .card-stats .stat-icon { display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border-radius: 50%; }
    .card-stats .stat { font-size: 2rem; font-weight: 700; line-height: 1; color: var(--text-primary); }
    .card-stats .stat-label { color: var(--text-secondary); font-size: 0.9rem; }
    .icon-primary { background-color: #e0e7ff; color: #4338ca; }
    .icon-success { background-color: #d1fae5; color: #059669; }
    .icon-warning { background-color: #fef3c7; color: #d97706; }
    .icon-info { background-color: #dbeafe; color: #2563eb; }

    /* --- TABLES --- */
    .table { border-color: var(--border-color); }
    .table thead { background-color: #f9fafb; }
    .table th { font-weight: 600; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.75rem 1rem; border-bottom-width: 1px; }
    .table td { vertical-align: middle; padding: 0.85rem 1rem; font-size: 0.95rem; }
    .table .text-truncate { max-width: 200px; }
    .table-hover > tbody > tr:hover { --bs-table-accent-bg: #f1f5f9; }

    /* --- FORMS & BUTTONS --- */
    .form-label { font-weight: 500; margin-bottom: 0.5rem; }
    .form-control, .form-select { border-radius: 0.5rem; border-color: #d1d5db; padding: 0.5rem 0.85rem; }
    .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
    .btn { border-radius: 0.5rem; font-weight: 600; padding: 0.5rem 1rem; transition: all 0.2s ease; }
    .btn-sm { padding: 0.35rem 0.7rem; font-size: 0.875rem; }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }

    /* Image Previews */
    .image-preview, .signature-preview { width: 100%; height: 120px; border: 2px dashed var(--border-color); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #fff; transition: border-color 0.2s; }
    .image-preview:hover, .signature-preview:hover { border-color: var(--primary-color); }
    .image-preview img, .signature-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    /* --- MODAL STYLES --- */
    .modal-details-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 0.5rem 1rem; }
    .modal-details-grid dt { font-weight: 600; color: var(--text-secondary); }
    .modal-details-grid dd { margin-bottom: 0.5rem; }
    .modal-image-container { border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem; height: 150px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #fff; }
    .modal-image-container img { max-height: 100%; max-width: 100%; object-fit: contain; }
    #dayEventsModal .list-group-item { cursor: pointer; }
    #dayEventsModal .list-group-item:hover { background-color: #f3f4f6; }

    /* Preview Modal Styles */
    .preview-modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .preview-item { margin-bottom: 0.75rem; }
    .preview-label { font-weight: 600; color: var(--text-secondary); margin-bottom: 0.25rem; }
    .preview-value { word-break: break-word; }

    /* --- CALENDAR CUSTOMIZATION --- */
    .fc .fc-button-primary { background-color: var(--primary-color) !important; border-color: var(--primary-color) !important; }
    .fc .fc-daygrid-day.fc-day-today { background-color: rgba(79, 70, 229, 0.05); }
    .fc-daygrid-event-count { 
      background-color: var(--primary-color); 
      color: white; 
      border-radius: 50%; 
      width: 22px;  /* Fixed typo */
      height: 22px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: 600; 
      font-size: 0.8em; 
      margin: 2px auto; 
    }
    .fc-daygrid-day-frame { position: relative; }

    /* Task styles */
    .task-row { border-left: 4px solid transparent; transition: all 0.2s; }
    .task-row:hover { background-color: #f8f9fa; border-left-color: var(--primary-color); }
    .task-row td { cursor: pointer; }
    .task-completed { text-decoration: line-through; opacity: 0.7; }
    .task-priority-high { border-left-color: #dc3545 !important; }
    .task-priority-medium { border-left-color: #fd7e14 !important; }
    .task-priority-low { border-left-color: #20c997 !important; }

    /* QR Code styles */
    .qr-code-container {
      display: flex;
      justify-content: center;
      margin: 15px 0;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: white;
    }
    
    /* Task Modal Styles */
    .task-modal-content {
      padding: 20px;
    }
    .task-detail-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .task-detail-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .task-detail-label {
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }
    .task-detail-value {
      font-size: 1.1rem;
    }

    /* Small QR code for inline display */
    .qr-small {
      width: 128px;
      height: 128px;
      border-radius: 8px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #eee;
      margin-top: 8px;
    }
    
    .small-muted {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .btn-outline-custom {
      border-radius: 8px;
    }

    /* Calendar day with events badge */
    .fc-daygrid-day-top {
      position: relative;
    }
    .day-event-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em;
      font-weight: bold;
      z-index: 5;
    }

    /* Mobile responsive */
    @media (max-width: 991px) {
      .sidebar { 
        position: fixed; 
        z-index: 1030; 
        left: 0; 
        top: 0; 
        width: 280px; 
        transform: translateX(-100%); 
      }
      .sidebar.show { 
        transform: translateX(0); 
        box-shadow: 0 0 2rem rgba(0,0,0,0.1); 
      }
      .main-content { 
        margin-left: 0; 
        padding: 1.5rem !important; 
      }
    }
    
    /* Chart Styles */
    .chart-container {
        height: 280px;
        width: 100%;
        margin: auto;
    }
    /* Fix for dashboard chart being squashed */
    #dashboardSection .card-body.d-flex {
        display: block !important;
    }

    /* Print styles for upcoming cases */
    @media print {
      body * {
        visibility: hidden !important;
      }
      .printable, .printable * {
        visibility: visible !important;
      }
      .printable {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 15px;
      }
      .printable table, .printable th, .printable td {
          visibility: visible !important;
      }
      .modal { display: none !important; }
    }

    /* Case Detail Modal Scroll */
    .case-detail-modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }

    /* Chart improvements */
    .chart-card {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }
    .chart-card .card-header {
      border-bottom: 1px solid rgba(0,0,0,0.05);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    /* Case Print Layout */
    .case-print-layout {
      width: 210mm;
      min-height: 297mm;
      padding: 15mm;
      margin: 0 auto;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .case-print-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #4f46e5;
      padding-bottom: 15px;
    }
    .case-print-section {
      margin-bottom: 20px;
      page-break-inside: avoid;
    }
    .case-print-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .case-print-field {
      margin-bottom: 10px;
    }
    .case-print-label {
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 5px;
    }
    .case-print-value {
      padding: 8px;
      background: #f9fafb;
      border-radius: 4px;
      border-left: 3px solid #4f46e5;
    }
    .case-print-full-width {
      grid-column: 1 / -1;
    }
    .case-print-images {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .case-print-image-container {
      width: 48%;
      text-align: center;
    }
    .case-print-image {
      max-width: 100%;
      max-height: 150px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 5px;
      background: white;
    }
    
    #backupSection .card { margin: 0 auto; max-width: 1100px; }
    #backupSection .container { margin: 0 auto; max-width: 1100px; }

    /* New Document Section Styles (FIXED: Removed 'nbsp;' characters) */
    .document-upload-card .card-body {
      padding-left: 0;
      padding-right: 0;
    }
    .document-upload-card .card-body form {
      padding: 1.25rem;
      padding-top: 0;
    }

    /* Footer Style */
    .app-footer {
      padding: 2rem 1.5rem 1.5rem;
      margin-top: 3rem;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
      border-top: 1px solid var(--border-color);
      background-color: var(--card-bg);
    }
    .app-footer p {
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }
    .app-footer .footer-company {
      font-weight: 600;
      color: var(--text-primary);
    }

    /* --- Record of Transaction redesign overrides (MERGED) --- */
    #transactionsSection {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background-color: transparent !important;
      padding: 0 !important;
    }
    #transactionsSection .page-title {
      font-size: 28px !important;
      font-weight: 700 !important;
      color: #102a43 !important;
      margin: 0 0 18px !important;
    }
    #transactionsSection .page-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 12px;
    }
    #transactionsSection .totals-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      align-items: stretch;
      margin-bottom: 18px;
    }
    #transactionsSection .totals-row .card {
      flex: 1 1 0;
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 6px 18px rgba(16, 42, 67, 0.06);
      display: flex;
      align-items: center;
      gap: 12px;
      background: #fff;
    }
    #transactionsSection .totals-row .card .icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    #transactionsSection .totals-row .card .icon-deposit {
      background-color: #e0f2f1;
      color: #00796b;
    }
    #transactionsSection .totals-row .card .icon-expense {
      background-color: #fbe9e7;
      color: #d84315;
    }
    #transactionsSection .totals-row .card .icon-balance {
      background-color: #e8f5e9;
      color: #388e3c;
    }
    #transactionsSection .totals-row .card .amount { 
      font-size: 24px; 
      font-weight:700; 
      line-height: 1.2;
    }
    #transactionsSection .totals-row .card .label { 
      font-size:13px; 
      color:#6b7280; 
      font-weight: 500;
    }
    #transactionsSection .totals-row .card.deposit .amount { color:#00796b; }
    #transactionsSection .totals-row .card.expense .amount { color:#d84315; }
    #transactionsSection .totals-row .card.balance .amount { color:#388e3c; }

    #transactionsSection .panels-row { 
      display:flex; 
      gap:18px; 
      align-items:flex-start; 
    }
    #transactionsSection .panel { 
      flex:1; 
      background:#fff; 
      border-radius:10px; 
      padding:0; 
      box-shadow:0 8px 24px rgba(16,42,67,0.06); 
      overflow:hidden; 
    }
    #transactionsSection .panel.form-panel {
      flex: 0 0 400px;
    }
    #transactionsSection .panel .panel-header { 
      padding:14px 18px; 
      border-bottom:1px solid #f1f5f9; 
      font-weight:700; 
      color:#134e4a; 
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #transactionsSection .panel .panel-body { 
      padding:18px; 
    }
    #transactionsSection .panel .table-responsive {
      max-height: 60vh;
      overflow-y: auto;
    }
    #transactionsSection .table-light thead th { 
      background: #f8fafc; 
      color:#6b7280; 
      font-weight:600; 
      border-bottom:1px solid #eef2f6; 
      font-size: 0.8rem;
    }
    #transactionsSection .table-light tbody td { 
      border-top: 1px solid #f1f5f9; 
      padding:14px 18px; 
      vertical-align: middle; 
      font-size: 0.9rem;
    }
    #transactionsSection .table-light tbody tr:first-child td {
      border-top: none;
    }

    #transactionsSection .actions .btn { 
      border-radius:8px; 
      padding:8px 12px; 
      font-size:14px; 
    }

    /* Responsive tweaks for new transaction design */
    @media (max-width: 1200px){
      #transactionsSection .panel.form-panel {
        flex: 0 0 350px;
      }
    }
    @media (max-width: 991px){
      #transactionsSection .panels-row { flex-direction: column; }
      #transactionsSection .panel.form-panel {
        flex: 1;
      }
      #transactionsSection .totals-row { 
        grid-template-columns: 1fr;
      }
    }
</style>
</head>
<body>
<div class="container-fluid">
<div class="row g-0">
<aside class="col-lg-2 sidebar p-3" id="sidebar">
<div class="d-flex align-items-center mb-4 p-2 sidebar-header">
<i class="fas fa-gavel me-2"></i>
<span>Case Management</span>
</div>
<nav class="nav flex-column mb-3">
<a class="nav-link active" data-target="dashboard" href="#"><i class="fas fa-fw fa-tachometer-alt me-2"></i> Dashboard</a>
<a class="nav-link" data-target="cases" href="#"><i class="fas fa-fw fa-folder-open me-2"></i> All Cases</a>
<a class="nav-link" data-target="add" href="#"><i class="fas fa-fw fa-user-plus me-2"></i> Add Client / Case</a>
<a class="nav-link" data-target="calendar" href="#"><i class="fas fa-fw fa-calendar-alt me-2"></i> Calendar</a>
<a class="nav-link" data-target="reports" href="#"><i class="fas fa-fw fa-chart-pie me-2"></i> Reports</a>
<a class="nav-link" data-target="tasks" href="#"><i class="fas fa-fw fa-tasks me-2"></i> Tasks</a>
<a class="nav-link" data-target="upcoming" href="#"><i class="fas fa-fw fa-clock me-2"></i> Upcoming Case</a>
<a class="nav-link" data-target="reminders" href="#"><i class="fas fa-fw fa-bell me-2"></i> Reminders</a>
<a class="nav-link" data-target="whatwork" href="#"><i class="fas fa-fw fa-clipboard-list me-2"></i> What work today</a>
<a class="nav-link" data-target="judgement" href="#"><i class="fas fa-fw fa-gavel me-2"></i> Judgement</a>
<a class="nav-link" data-target="law" href="#"><i class="fas fa-fw fa-balance-scale me-2"></i> Law</a>
<a class="nav-link" data-target="formfile" href="#"><i class="fas fa-fw fa-file-alt me-2"></i> Form/File</a>
<a class="nav-link" data-target="transactions" href="#"><i class="fas fa-fw fa-money-bill-wave me-2"></i> Daily Transaction</a>
<a class="nav-link" data-target="backup" href="#"><i class="fas fa-fw fa-database me-2"></i> Backup</a>
</nav>
<hr class="text-secondary"/>
<div class="filters">
<h6 class="h6 small text-muted mb-3">Filters</h6>
<div class="mb-3">
<label class="form-label small mb-1">Court</label>
<select class="form-select form-select-sm" id="filterCourt"><option value="">All Courts</option></select>
</div>
<div class="mb-3">
<label class="form-label small mb-1">Year</label>
<select class="form-select form-select-sm" id="filterYear"><option value="">All Years</option></select>
</div>
<div>
<label class="form-label small mb-1">Status</label>
<select class="form-select form-select-sm" id="filterStatus">
<option value="">All Status</option>
<option>Active</option><option>Pending</option><option>Closed</option><option>No Steps</option>
</select>
</div>
</div>
</aside>
<main class="col-lg-10 main-content">
<div class="d-flex align-items-center mb-4">
<button class="btn btn-outline-secondary d-lg-none me-3" id="toggleSidebar"><i class="fas fa-bars"></i></button>
<h2 class="me-auto mb-0 main-title">Dashboard</h2>
<div class="d-flex align-items-center gap-2">
<div class="input-group" style="max-width:350px;">
<input aria-label="Search" class="form-control" id="searchInput" placeholder="Search cases..." type="search"/>
<button class="btn btn-outline-secondary" id="btnSearch"><i class="fas fa-search"></i></button>
</div>
<button class="btn btn-outline-secondary" id="btnRefresh" title="Refresh Data"><i class="fas fa-sync-alt"></i></button>
</div>
</div>
<section class="section active" id="dashboardSection">
<div class="row g-4 mb-4">
<div class="col-md-6 col-xl-3">
<div class="card card-stats">
<div class="card-body">
<div>
<div class="stat" id="cardTotal">0</div>
<div class="stat-label">Total Cases</div>
</div>
<div class="stat-icon icon-primary"><i class="fas fa-folder fa-lg"></i></div>
</div>
</div>
</div>
<div class="col-md-6 col-xl-3">
<div class="card card-stats">
<div class="card-body">
<div>
<div class="stat" id="cardActive">0</div>
<div class="stat-label">Active Cases</div>
</div>
<div class="stat-icon icon-success"><i class="fas fa-clock fa-lg"></i></div>
</div>
</div>
</div>
<div class="col-md-6 col-xl-3">
<div class="card card-stats">
<div class="card-body">
<div>
<div class="stat" id="cardUpcoming">0</div>
<div class="stat-label">Upcoming Hearings</div>
</div>
<div class="stat-icon icon-warning"><i class="fas fa-calendar-day fa-lg"></i></div>
</div>
</div>
</div>
<div class="col-md-6 col-xl-3">
<div class="card card-stats">
<div class="card-body">
<div>
<div class="stat" id="cardCourts">0</div>
<div class="stat-label">Different Courts</div>
</div>
<div class="stat-icon icon-info"><i class="fas fa-balance-scale fa-lg"></i></div>
</div>
</div>
</div>
<div class="col-md-6 col-xl-3">
<div class="card card-stats">
<div class="card-body">
<div>
<div class="stat" id="cardTasks">0</div>
<div class="stat-label">Total Tasks</div>
</div>
<div class="stat-icon icon-primary"><i class="fas fa-tasks fa-lg"></i></div>
</div>
</div>
</div>
<div class="col-md-6 col-xl-3">
<div class="card card-stats">
<div class="card-body">
<div>
<div class="stat" id="cardReminders">0</div>
<div class="stat-label">Total Reminders</div>
</div>
<div class="stat-icon icon-warning"><i class="fas fa-bell fa-lg"></i></div>
</div>
</div>
</div>
</div>
<div class="row g-4">
<div class="col-lg-6">
<div class="card h-100">
<div class="card-header d-flex align-items-center">
<strong>Cases by Case Type</strong>
<div class="ms-auto">
<button class="btn btn-sm btn-outline-secondary" id="exportCSV"><i class="fas fa-file-csv me-1"></i> Export CSV</button>
</div>
</div>
<div class="card-body d-flex align-items-center">
<canvas height="200" id="caseTypeDashboardChart"></canvas>
</div>
</div>
</div>
<div class="col-lg-6">
<div class="card h-100">
<div class="card-header"><strong>Events Calendar</strong></div>
<div class="card-body">
<div id="dashboardCalendar"></div>
</div>
</div>
</div>
</div>
<div class="card mt-4">
<div class="card-header d-flex align-items-center">
<strong>Tasks</strong>
<div class="ms-auto">
<button class="btn btn-sm btn-primary" data-bs-target="#taskModal" data-bs-toggle="modal" id="btnAddTaskDashboard"><i class="fas fa-plus me-1"></i> Add Task</button>
</div>
</div>
<div class="card-body p-0">
<div class="table-responsive">
<table class="table table-hover mb-0">
<thead>
<tr>
<th style="width:5%;">Sl.</th>
<th style="width:15%;">Date</th>
<th style="width:60%;">Note</th>
<th style="width:10%;">Priority</th>
<th style="width:10%;">Actions</th>
</tr>
</thead>
<tbody id="tasksBody"></tbody>
</table>
</div>
</div>
</div>
</section>
<section class="section" id="casesSection" style="display:none;">
<div class="card">
<div class="card-header d-flex align-items-center">
<h4 class="mb-0 me-auto">All Cases</h4>
<div class="d-flex gap-2">
<button class="btn btn-sm btn-outline-danger" id="exportCasesPDF"><i class="fas fa-file-pdf me-1"></i> Save as PDF</button>
<button class="btn btn-sm btn-outline-success" onclick="exportDataToXLSX()"><i class="fas fa-file-excel me-1"></i> Export XLSX</button>
<input accept=".xlsx,.xls" id="importXLSXInputCase" style="display:none;" type="file">
<button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('importXLSXInputCase').click();"><i class="fas fa-file-import me-1"></i> Import XLSX</button>
</div>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-hover mb-0" id="casesTable">
<thead>
<tr>
<th style="width:10%">Case Type</th>
<th style="width:10%">Case No</th>
<th style="width:5%">Year</th>
<th style="width:12%">Court</th>
<th style="width:18%">Parties</th>
<th style="width:10%">Next Hearing</th>
<th style="width:10%">Contact</th>
<th style="width:12%">Address</th>
<th style="width:5%">Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="card-footer bg-white d-flex justify-content-between align-items-center">
<div>
<small class="text-muted" id="casesCount">0 cases</small>
</div>
<nav>
<ul class="pagination pagination-sm mb-0" id="pagination"></ul>
</nav>
</div>
</div>
</section>
<section class="section" id="addSection" style="display:none;">
<div class="d-flex align-items-center mb-3">
<h4 class="mb-0 me-auto main-title">Add Client / Case</h4>
</div>
<div class="card mb-4">
<div class="card-body">
<form autocomplete="off" id="caseForm">
<input id="caseId" type="hidden"/>
<div class="row g-3">
<div class="col-md-3">
<div class="mb-3">
<label class="form-label">Client Photo</label>
<input accept=".jpg,.jpeg,.png" class="form-control form-control-sm" id="photo" type="file"/>
<div class="image-preview mt-2" id="photoPreview"><small class="text-muted">Preview</small></div>
<small class="small-muted">JPG/PNG, max 300KB</small>
</div>
<div class="mb-3">
<label class="form-label">Client Signature</label>
<input accept=".jpg,.jpeg,.png" class="form-control form-control-sm" id="signature" type="file"/>
<div class="signature-preview mt-2" id="signaturePreview"><small class="text-muted">Preview</small></div>
<small class="small-muted">JPG/PNG, max 200KB</small>
</div>
<div class="mt-3">
<label class="form-label">QR Code</label>
<div class="qr-small mt-2" id="inlineQr"></div>
<small class="small-muted d-block mt-1">Auto-generated for the case</small>
</div>
</div>
<div class="col-md-9">
<div class="row g-2">
<div class="col-md-5">
<label class="form-label">Select Court / Authority <span class="text-danger">*</span></label>
<div class="d-flex gap-2">
<select class="form-select" id="court" required="">
<option value="">-- Select Court --</option>
</select>
<button class="btn btn-outline-secondary btn-outline-custom" id="addCourtBtn" title="Add new court/authority" type="button">+</button>
<button class="btn btn-outline-danger btn-outline-custom" id="removeCourtBtn" title="Remove selected court" type="button">-</button>
</div>
</div>
<div class="col-md-4">
<label class="form-label">Case Type</label>
<div class="d-flex gap-2">
<select aria-label="Case Type" class="form-select" id="caseType">
<option value="">-- Select Case Type --</option>
</select>
<button class="btn btn-outline-secondary btn-outline-custom" id="addCaseTypeBtn" title="Add new case type" type="button">+</button>
<button class="btn btn-outline-danger btn-outline-custom" id="removeCaseTypeBtn" title="Remove selected case type" type="button">-</button>
</div>
</div>
<div class="col-md-3">
<label class="form-label">Case No <span class="text-danger">*</span></label>
<input class="form-control" id="caseNo" required=""/>
</div>
<div class="col-md-2">
<label class="form-label">Year <span class="text-danger">*</span></label>
<input class="form-control" id="year" max="2100" min="1900" required="" type="number"/>
</div>
<div class="col-md-5">
<label class="form-label"> Parties (Versus)</label>
<input class="form-control" id="parties"/>
</div>
<div class="col-md-3">
<label class="form-label">My Client</label>
<select class="form-select" id="clientType">
<option value="">-- Select --</option>
<option>Plaintiff</option>
<option>Defendant</option>
<option>Appellant</option>
<option>Respondent</option>
<option>Opp. Party</option>
<option>Applicant</option>
</select>
</div>
<div class="col-md-2">
<label class="form-label">Contact No.</label>
<input class="form-control" id="contact"/>
</div>
<div class="col-md-2">
<label class="form-label">Have Injunction</label>
<select class="form-select" id="injunction">
<option value="No">No</option>
<option value="Yes">Yes</option>
</select>
</div>
<div class="col-md-2">
<label class="form-label">Priority</label>
<select class="form-select" id="priority">
<option>Low</option><option selected="">Medium</option><option>High</option>
</select>
</div>
<div class="col-md-4">
<label class="form-label">CNR No.</label>
<input class="form-control" id="cnr"/>
</div>
<div class="col-md-4">
<label class="form-label">Filing Date</label>
<input class="form-control" id="filingDate" type="date"/>
</div>
<div class="col-md-4">
<label class="form-label">Next Hearing</label>
<input class="form-control" id="nextHearing" type="date"/>
</div>
<div class="col-md-4">
<label class="form-label">Status</label>
<select class="form-select" id="status">
<option>Active</option><option>Pending</option><option>Closed</option><option>No Steps</option>
</select>
</div>
<div class="col-12">
<label class="form-label">Address</label>
<input class="form-control" id="address"/>
</div>
<div class="col-12">
<label class="form-label">Total Money Record History</label>
<input class="form-control" id="moneyHistory"/>
</div>
<div class="col-12">
<label class="form-label">In connection with case or link case</label>
<select class="form-select" id="linkedCase">
<option value="">-- Select Linked Case --</option>
</select>
</div>
<div class="col-12">
<label class="form-label">Purpose (After Next Hearing)</label>
<input class="form-control" id="purpose" placeholder="Purpose of next hearing"/>
</div>
<div class="col-12">
<label class="form-label">Advocate / Farm details</label>
<textarea class="form-control" id="advocateDetails" rows="2" placeholder="Advocate or farm details"></textarea>
</div>
<div class="col-12">
<label class="form-label">Extra Note</label>
<textarea class="form-control" id="extraNote" rows="2" placeholder="Additional notes"></textarea>
</div>
<div class="col-12">
<label class="form-label">Upload Documents (Plain, W.S., W.O., etc.)</label>
<input accept=".doc,.docx,.pdf,.jpg,.jpeg,.png" class="form-control" id="documentUpload" multiple="" type="file"/>
<small class="text-muted">You can select multiple files (.doc, .docx, .pdf, images)</small>
</div>
<div class="col-12">
<label class="form-label">Special Judgement of this Case</label>
<textarea class="form-control" id="specialJudgement" rows="3"></textarea>
</div>
<div class="col-12">
<label class="form-label">Gist / Note</label>
<textarea class="form-control" id="details" rows="3"></textarea>
</div>
<div class="col-12 d-flex justify-content-end gap-2 mt-2">
<button class="btn btn-outline-info" id="previewBtn" type="button">Preview</button>
<button class="btn btn-outline-secondary" id="clearBtn" type="button">Clear</button>
<button class="btn btn-primary" id="saveBtn" type="submit">Add Case</button>
</div>
</div> </div> </div> </form>
</div>
</div>
</section>
<section class="section" id="judgementSection" style="display:none;">
    <div class="card document-upload-card">
        <div class="card-header d-flex align-items-center">
            <h4 class="mb-0 me-auto">Judgements Archive</h4>
        </div>
        <div class="card-body">
            <form id="documentForm_JUDGEMENT">
                <input type="hidden" id="docId_JUDGEMENT" />
                <div class="mb-3">
                    <label class="form-label">Document Name/Title <span class="text-danger">*</span></label>
                    <input class="form-control" type="text" id="docName_JUDGEMENT" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Select File (PDF, DOCX, etc.)</label>
                    <input class="form-control" type="file" id="docFile_JUDGEMENT" accept=".doc,.docx,.pdf,.jpg,.jpeg,.png">
                    <small class="text-muted" id="docFileHelp_JUDGEMENT">Select a file to upload. (Required for new documents)</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes/Details</label>
                    <textarea class="form-control" id="docNote_JUDGEMENT" rows="2"></textarea>
                </div>
                <div class="text-end d-flex gap-2 justify-content-end">
                    <button class="btn btn-outline-secondary" id="docCancelBtn_JUDGEMENT" type="button" style="display: none;">Cancel</button>
                    <button class="btn btn-primary" type="submit" id="docSaveBtn_JUDGEMENT"><i class="fas fa-upload me-1"></i> Upload Judgement</button>
                </div>
            </form>
            <div class="table-responsive mt-3">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width:5%;">Sl.</th>
                            <th style="width:50%;">Title</th>
                            <th style="width:20%;">Date Uploaded</th>
                            <th style="width:25%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentTableBody_JUDGEMENT"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>
<section class="section" id="lawSection" style="display:none;">
    <div class="card document-upload-card">
        <div class="card-header d-flex align-items-center">
            <h4 class="mb-0 me-auto">Statutes / Law Library</h4>
        </div>
        <div class="card-body">
            <form id="documentForm_LAW">
                <input type="hidden" id="docId_LAW" />
                <div class="mb-3">
                    <label class="form-label">Statute/Law Name <span class="text-danger">*</span></label>
                    <input class="form-control" type="text" id="docName_LAW" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Select File (PDF, DOCX, etc.)</label>
                    <input class="form-control" type="file" id="docFile_LAW" accept=".doc,.docx,.pdf,.jpg,.jpeg,.png">
                    <small class="text-muted" id="docFileHelp_LAW">Select a file to upload. (Required for new documents)</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes/Details (e.g., relevant sections)</label>
                    <textarea class="form-control" id="docNote_LAW" rows="2"></textarea>
                </div>
                <div class="text-end d-flex gap-2 justify-content-end">
                    <button class="btn btn-outline-secondary" id="docCancelBtn_LAW" type="button" style="display: none;">Cancel</button>
                    <button class="btn btn-primary" type="submit" id="docSaveBtn_LAW"><i class="fas fa-upload me-1"></i> Upload Law File</button>
                </div>
            </form>
            <div class="table-responsive mt-3">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width:5%;">Sl.</th>
                            <th style="width:50%;">Title</th>
                            <th style="width:20%;">Date Uploaded</th>
                            <th style="width:25%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentTableBody_LAW"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>
<section class="section" id="formfileSection" style="display:none;">
    <div class="card document-upload-card">
        <div class="card-header d-flex align-items-center">
            <h4 class="mb-0 me-auto">General Forms / Files</h4>
        </div>
        <div class="card-body">
            <form id="documentForm_FORM">
                <input type="hidden" id="docId_FORM" />
                <div class="mb-3">
                    <label class="form-label">File Name/Description <span class="text-danger">*</span></label>
                    <input class="form-control" type="text" id="docName_FORM" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Select File (PDF, DOCX, etc.)</label>
                    <input class="form-control" type="file" id="docFile_FORM" accept=".doc,.docx,.pdf,.jpg,.jpeg,.png">
                    <small class="text-muted" id="docFileHelp_FORM">Select a file to upload. (Required for new documents)</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="docNote_FORM" rows="2"></textarea>
                </div>
                <div class="text-end d-flex gap-2 justify-content-end">
                    <button class="btn btn-outline-secondary" id="docCancelBtn_FORM" type="button" style="display: none;">Cancel</button>
                    <button class="btn btn-primary" type="submit" id="docSaveBtn_FORM"><i class="fas fa-upload me-1"></i> Upload General File</button>
                </div>
            </form>
            <div class="table-responsive mt-3">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width:5%;">Sl.</th>
                            <th style="width:50%;">Title</th>
                            <th style="width:20%;">Date Uploaded</th>
                            <th style="width:25%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentTableBody_FORM"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>
<section class="section" id="calendarSection" style="display:none;">
<div class="card">
<div class="card-header d-flex align-items-center">
<strong>Calendar</strong>
<div class="ms-auto">
<button class="btn btn-sm btn-outline-secondary" id="btnRefreshCalendar">Refresh</button>
</div>
</div>
<div class="card-body">
<div id="bigCalendar"></div>
</div>
</div>
</section>
<section class="section" id="reportsSection" style="display:none;">
<div class="row g-4">
<div class="col-lg-6">
<div class="card chart-card">
<div class="card-header"><strong>Cases by Status</strong></div>
<div class="card-body">
<div class="chart-container"><canvas height="180" id="statusChart"></canvas></div>
</div>
</div>
</div>
<div class="col-lg-6">
<div class="card chart-card">
<div class="card-header"><strong>Cases by Year</strong></div>
<div class="card-body">
<div class="chart-container"><canvas height="180" id="yearChart"></canvas></div>
</div>
</div>
</div>
<div class="col-lg-6">
<div class="card chart-card">
<div class="card-header"><strong>Cases by Court</strong></div>
<div class="card-body">
<div class="chart-container"><canvas height="180" id="courtChart"></canvas></div>
</div>
</div>
</div>
<div class="col-lg-6">
<div class="card chart-card">
<div class="card-header"><strong>Cases by Case Type</strong></div>
<div class="card-body">
<div class="chart-container"><canvas height="180" id="caseTypeReportChart"></canvas></div>
</div>
</div>
</div>
</div>
<div class="mt-3 d-flex gap-2">
<button class="btn btn-sm btn-outline-secondary" id="exportCsvBtn"><i class="fas fa-file-csv"></i> Export CSV</button>
<button class="btn btn-sm btn-outline-secondary" id="printReportBtn"><i class="fas fa-print"></i> Print</button>
</div>
</section>
<section class="section" id="tasksSection" style="display:none;">
<div class="card">
<div class="card-header d-flex align-items-center">
<strong>Tasks</strong>
<div class="ms-auto">
<button class="btn btn-sm btn-primary" data-bs-target="#taskModal" data-bs-toggle="modal" id="btnAddTaskPage"><i class="fas fa-plus me-1"></i> Add Task</button>
</div>
</div>
<div class="card-body p-0">
<div class="table-responsive">
<table class="table table-hover mb-0">
<thead>
<tr>
<th style="width:5%;">Sl.</th>
<th style="width:15%;">Date</th>
<th style="width:60%;">Note</th>
<th style="width:10%;">Priority</th>
<th style="width:10%;">Actions</th>
</tr>
</thead>
<tbody id="tasksTableBody"></tbody>
</table>
</div>
</div>
</div>
</section>
<section class="section" id="upcomingSection" style="display:none;">
<div class="card">
<div class="card-header d-flex align-items-center">
<h4 class="mb-0 me-auto">Upcoming Cases</h4>
<div class="d-flex align-items-center gap-2">
<select class="form-select form-select-sm" id="upcomingRange" style="width:150px;">
<option value="7">Next 1 Week</option>
<option value="14">Next 2 Weeks</option>
<option selected="" value="30">Next 1 Month</option>
<option value="90">Next 3 Months</option>
</select>
<button class="btn btn-sm btn-outline-secondary" id="btnPrintUpcoming"><i class="fas fa-print me-1"></i> Print</button>
<button class="btn btn-sm btn-outline-danger" id="exportUpcomingPDF"><i class="fas fa-file-pdf me-1"></i> Save as PDF</button>
</div>
</div>
<div class="card-body p-0">
<div class="table-responsive printable">
<table class="table table-hover mb-0">
<thead>
<tr>
<th style="width:12%;">Case No.</th>
<th style="width:8%;">Year</th>
<th style="width:16%;">Court Name</th>
<th>Parties</th>
<th style="width:12%;">Date</th>
<th style="width:12%;">Purpose</th>
<th style="width:12%;">Contact No</th>
<th style="width:10%;">Injunction</th>
<th style="width:5%;">Actions</th>
</tr>
</thead>
<tbody id="upcomingBody"></tbody>
</table>
</div>
</div>
</div>
</section>
<section class="section" id="remindersSection" style="display:none;">
<div class="row g-4">
<div class="col-lg-5">
<div class="card">
<div class="card-header d-flex align-items-center">
<strong>All Reminders</strong>
<div class="ms-auto">
<button class="btn btn-sm btn-primary" data-bs-target="#reminderModal" data-bs-toggle="modal" id="btnAddReminderPage"><i class="fas fa-plus me-1"></i> Add Reminder</button>
</div>
</div>
<div class="card-body p-0">
<div class="table-responsive">
<table class="table table-hover mb-0">
<thead>
<tr>
<th style="width:5%;">Sl.</th>
<th style="width:15%;">Date</th>
<th style="width:65%;">Note</th>
<th style="width:15%;">Actions</th>
</tr>
</thead>
<tbody id="remindersTableBody"></tbody>
</table>
</div>
</div>
</div>
</div>
<div class="col-lg-7">
<div class="card h-100">
<div class="card-header"><strong>Reminder Calendar</strong></div>
<div class="card-body">
<div id="remindersCalendar"></div>
</div>
</div>
</div>
</div>
</section>
<section class="section" id="whatworkSection" style="display:none;">
<div class="row g-4">
<div class="col-lg-5">
<div class="card">
<div class="card-header d-flex align-items-center">
<strong>What work today</strong>
</div>
<div class="card-body">
<form autocomplete="off" id="whatworkForm">
<input id="whatworkId" type="hidden"/>
<div class="mb-3">
<label class="form-label">Date <span class="text-danger">*</span></label>
<input class="form-control" id="whatworkDate" required="" type="date"/>
</div>
<div class="mb-3">
<label class="form-label">Note <span class="text-danger">*</span></label>
<textarea class="form-control" id="whatworkNote" required="" rows="4"></textarea>
</div>
<div class="d-flex gap-2">
<button class="btn btn-danger" id="btnDeleteWhatwork" style="display:none;" type="button">Delete</button>
<button class="btn btn-primary" id="btnSaveWhatwork" type="submit">Save</button>
<button class="btn btn-outline-secondary" id="btnClearWhatwork" type="button">Clear</button>
</div>
</form>
</div>
</div>
</div>
<div class="col-lg-7">
<div class="card h-100">
<div class="card-header d-flex align-items-center">
<strong>All: What work today</strong>
<div class="ms-auto small-muted" id="whatworkCount">0 items</div>
</div>
<div class="card-body p-0">
<div class="table-responsive">
<table class="table table-hover mb-0">
<thead>
<tr>
<th style="width:5%;">Sl.</th>
<th style="width:15%;">Date</th>
<th>Note</th>
<th style="width:15%;">Actions</th>
</tr>
</thead>
<tbody id="whatworkTableBody"></tbody>
</table>
</div>
</div>
<div class="card-footer bg-white d-flex justify-content-between align-items-center">
<small class="text-muted" id="whatworkFooter">Showing 0</small>
<nav>
<ul class="pagination pagination-sm mb-0" id="whatworkPagination"></ul>
</nav>
</div>
</div>
</div>
</div>
</section>
<section class="section" id="transactionsSection" style="display:none;">
<h2 class="page-title">Daily Transaction</h2>
<div class="totals-row">
  <div class="card deposit">
    <div class="icon icon-deposit"><i class="fas fa-dollar-sign"></i></div>
    <div>
      <div class="amount" id="totalDeposit">₹0.00</div>
      <div class="label">Total Deposit</div>
    </div>
  </div>
  <div class="card expense">
    <div class="icon icon-expense"><i class="fas fa-receipt"></i></div>
    <div>
      <div class="amount" id="totalExpense">₹0.00</div>
      <div class="label">Total Expense</div>
    </div>
  </div>
  <div class="card balance">
    <div class="icon icon-balance"><i class="fas fa-balance-scale"></i></div>
    <div>
      <div class="amount" id="currentBalance">₹0.00</div>
      <div class="label">Current Balance</div>
    </div>
  </div>
</div>

<div class="panels-row">
  <div class="panel form-panel">
    <div class="panel-header">
      <h6 class="mb-0">New Transaction</h6>
    </div>
    <div class="panel-body">
      <form id="transactionForm">
        <input id="transactionId" type="hidden"/>
        <div class="mb-3">
          <label class="form-label">Date <span class="text-danger">*</span></label>
          <input class="form-control" id="transactionDate" required="" type="date"/>
        </div>
        <div class="mb-3">
          <label class="form-label">Type <span class="text-danger">*</span></label>
          <select class="form-select" id="transactionType" required="">
            <option value="">-- Select Type --</option>
            <option value="Deposit">Deposit</option>
            <option value="Expense">Expense</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Amount <span class="text-danger">*</span></label>
          <input class="form-control" id="transactionAmount" min="0.01" required="" step="0.01" type="number"/>
        </div>
        <div class="mb-3">
          <label class="form-label">Description <span class="text-danger">*</span></label>
          <textarea class="form-control" id="transactionDescription" required="" rows="3"></textarea>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-danger" id="btnDeleteTransaction" style="display:none;" type="button">Delete</button>
          <button class="btn btn-primary" id="btnSaveTransaction" type="submit">Save Transaction</button>
          <button class="btn btn-outline-secondary" id="btnClearTransaction" type="button">Clear</button>
        </div>
      </form>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <h6 class="mb-0">Transaction History</h6>
      <div class="page-controls">
        <button class="btn btn-sm btn-outline-success" id="exportTransactionXLSX"><i class="fas fa-file-excel me-1"></i> Export XLSX</button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-light mb-0" id="transactionTable">
        <thead>
          <tr>
            <th style="width:15%">Date</th>
            <th style="width:15%">Type</th>
            <th style="width:45%">Description</th>
            <th class="text-end" style="width:15%">Amount</th>
            <th style="width:10%">Actions</th>
          </tr>
        </thead>
        <tbody id="transactionTableBody"></tbody>
      </table>
    </div>
    <div class="panel-body pt-2 pb-2" style="border-top: 1px solid #f1f5f9;">
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted" id="transactionFooter">Showing 0</small>
        <nav>
          <ul class="pagination pagination-sm mb-0" id="transactionPagination"></ul>
        </nav>
      </div>
    </div>
  </div>
</div>
</section>
<section class="section" id="backupSection" style="display:none;">
<div class="container py-4">
<h4 class="mb-4 main-title text-center">Data Backup & Restore</h4>
<div class="card p-4 shadow-sm">
<div class="row g-4">
<div class="col-md-6">
<div class="border p-3 h-100 rounded-3 bg-light">
<h5 class="mb-3"><i class="fas fa-download me-2 text-primary"></i> Backup Data (Export)</h5>
<p class="text-muted">Save a copy of your current case manager data (all cases, tasks, reminders, and transactions) to a file on your device. This is essential for safety.</p>
<button class="btn btn-primary w-100 mt-2" id="exportBackup">
<i class="fas fa-file-export me-1"></i> Export Backup (JSON)
</button>
<small class="d-block text-muted mt-2">Export file name: **case_manager_backup.json**</small>
</div>
</div>
<div class="col-md-6">
<div class="border p-3 h-100 rounded-3 bg-light">
<h5 class="mb-3"><i class="fas fa-upload me-2 text-success"></i> Restore Data (Import)</h5>
<p class="text-muted">Load data from a previously exported backup file. **Warning:** This will overwrite all your current data!</p>
<input accept=".json" class="form-control mt-2" id="importBackupFile" type="file"/>
<button class="btn btn-success w-100 mt-3" id="importBackup" disabled="">
<i class="fas fa-file-import me-1"></i> Import & Restore Data
</button>
</div>
</div>
<div class="col-12 mt-4">
<div class="border p-3 rounded-3 bg-light">
<h5 class="mb-3 text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Danger Zone</h5>
<p class="text-muted">Permanently delete all data stored in the Case Manager. This action is irreversible.</p>
<button class="btn btn-danger" id="clearAllData">
<i class="fas fa-trash-alt me-1"></i> Permanently Delete All Data
</button>
</div>
</div>
</div>
</div>
</div>
</section>

<footer class="app-footer">
    <p class="mb-1">
        <span class="footer-company">Rajesh Corporation Pvt. Ltd.</span>
        <br>
        Suk Pukuria, Beonta, Hatisala, South 24 Pgs., 743502, West Bengal
        <br>
        Mob: 6297452374
    </p>
    <p class="mb-0">
        &copy; 2025 Case Manager Pro. All rights reserved.
        <br>
        <small>Design and developed by Rajesh Corporation Pvt. Ltd.</small>
    </p>
</footer>
</main>
</div>
</div>
<div aria-hidden="true" aria-labelledby="caseDetailModalLabel" class="modal fade" id="caseDetailModal" tabindex="-1">
<div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="caseDetailModalLabel">Case Details: <span id="modalCaseNo"></span></h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body case-detail-modal-body">
<div class="row g-4">
<div class="col-lg-3">
<div class="card h-100">
<div class="card-body text-center">
<div class="modal-image-container mb-3" id="modalPhotoContainer">
<small class="text-muted">Client Photo</small>
</div>
<div class="modal-image-container mb-3" id="modalSignatureContainer">
<small class="text-muted">Client Signature</small>
</div>
<div class="qr-code-container" id="modalQrCode"></div>
</div>
</div>
</div>
<div class="col-lg-9">
<div class="card mb-4">
<div class="card-header">Case Information</div>
<div class="card-body">
<dl class="modal-details-grid">
<dt>Court / Authority</dt><dd id="modalCourt"></dd>
<dt>Case Type</dt><dd id="modalCaseType"></dd>
<dt>Case No & Year</dt><dd id="modalCaseNumYear"></dd>
<dt>Parties (Vs)</dt><dd id="modalParties"></dd>
<dt>My Client Status</dt><dd id="modalClientType"></dd>
<dt>Filing Date</dt><dd id="modalFilingDate"></dd>
<dt>CNR No.</dt><dd id="modalCNR"></dd>
<dt>Priority</dt><dd><span class="badge" id="modalPriorityBadge"></span></dd>
<dt>Injunction</dt><dd id="modalInjunction"></dd>
<dt>Status</dt><dd><span class="badge" id="modalStatusBadge"></span></dd>
<dt>Purpose</dt><dd id="modalPurpose"></dd>
<dt>Advocate Details</dt><dd id="modalAdvocateDetails"></dd>
<dt>Extra Note</dt><dd id="modalExtraNote"></dd>
</dl>
</div>
</div>
<div class="card mb-4">
<div class="card-header">Client & Contact</div>
<div class="card-body">
<dl class="modal-details-grid">
<dt>Contact No.</dt><dd id="modalContact"></dd>
<dt>Address</dt><dd id="modalAddress"></dd>
<dt>Money Record History</dt><dd id="modalMoneyHistory"></dd>
<dt>Linked Case</dt><dd id="modalLinkedCase"></dd>
</dl>
</div>
</div>
</div>
</div>
<div class="row g-4">
<div class="col-12">
<div class="card">
<div class="card-header">Next Hearing & History</div>
<div class="card-body">
<div class="row g-3">
<div class="col-md-4">
<div class="p-3 bg-light rounded-3">
<h6 class="text-muted small mb-1">Next Hearing Date</h6>
<h4 class="mb-0 text-primary fw-bold" id="modalNextHearing"></h4>
</div>
</div>
<div class="col-md-8">
<form class="d-flex gap-2" id="nextHearingForm">
<input class="form-control" id="newNextHearing" required="" type="date"/>
<button class="btn btn-success" type="submit">Update Next Hearing</button>
</form>
</div>
</div>
<hr/>
<h6 class="fw-bold">Hearing History</h6>
<div class="table-responsive mt-3">
<table class="table table-sm table-bordered mb-0">
<thead>
<tr>
<th style="width:30%">Date</th>
<th style="width:70%">Details</th>
<th style="width:10%">Actions</th>
</tr>
</thead>
<tbody id="hearingHistoryBody">
<td colspan="3" class="text-center text-muted">No history found.</td>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="col-12">
<div class="card">
<div class="card-header">Special Judgement / Orders</div>
<div class="card-body">
<p id="modalSpecialJudgement" style="white-space: pre-wrap;"></p>
</div>
</div>
</div>
<div class="col-12">
<div class="card">
<div class="card-header">Gist / Details</div>
<div class="card-body">
<p id="modalDetails" style="white-space: pre-wrap;"></p>
</div>
</div>
</div>
</div>
</div>
<div class="modal-footer d-flex justify-content-between">
<div>
<button class="btn btn-outline-info" id="btnPrintCase" type="button"><i class="fas fa-print me-1"></i> Print Case</button>
<button class="btn btn-outline-danger" id="exportCasePDF" type="button"><i class="fas fa-file-pdf me-1"></i> Export PDF</button>
</div>
<div>
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
<button class="btn btn-primary" id="btnEditCase" type="button">Edit Case</button>
<button class="btn btn-danger" id="btnDeleteCase" type="button">Delete Case</button>
</div>
</div>
</div>
</div>
</div>

<div aria-hidden="true" aria-labelledby="previewModalLabel" class="modal fade" id="previewModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="previewModalLabel">Case Submission Preview</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="preview-modal-grid">
<div class="preview-item">
<div class="preview-label">Court / Authority</div>
<div class="preview-value" id="previewCourt"></div>
</div>
<div class="preview-item">
<div class="preview-label">Case Type</div>
<div class="preview-value" id="previewCaseType"></div>
</div>
<div class="preview-item">
<div class="preview-label">Case No & Year</div>
<div class="preview-value" id="previewCaseNoYear"></div>
</div>
<div class="preview-item">
<div class="preview-label">Parties (Vs)</div>
<div class="preview-value" id="previewParties"></div>
</div>
<div class="preview-item">
<div class="preview-label">My Client Status</div>
<div class="preview-value" id="previewClientType"></div>
</div>
<div class="preview-item">
<div class="preview-label">Contact No.</div>
<div class="preview-value" id="previewContact"></div>
</div>
<div class="preview-item">
<div class="preview-label">Next Hearing</div>
<div class="preview-value" id="previewNextHearing"></div>
</div>
<div class="preview-item">
<div class="preview-label">Status</div>
<div class="preview-value" id="previewStatus"></div>
</div>
<div class="preview-item">
<div class="preview-label">CNR No.</div>
<div class="preview-value" id="previewCNR"></div>
</div>
<div class="preview-item">
<div class="preview-label">Filing Date</div>
<div class="preview-value" id="previewFilingDate"></div>
</div>
<div class="preview-item">
<div class="preview-label">Have Injunction</div>
<div class="preview-value" id="previewInjunction"></div>
</div>
<div class="preview-item">
<div class="preview-label">Priority</div>
<div class="preview-value" id="previewPriority"></div>
</div>
<div class="preview-item">
<div class="preview-label">Purpose</div>
<div class="preview-value" id="previewPurpose"></div>
</div>
<div class="preview-item preview-full-width">
<div class="preview-label">Advocate / Farm Details</div>
<div class="preview-value" id="previewAdvocateDetails" style="white-space: pre-wrap;"></div>
</div>
<div class="preview-item preview-full-width">
<div class="preview-label">Extra Note</div>
<div class="preview-value" id="previewExtraNote" style="white-space: pre-wrap;"></div>
</div>
<div class="preview-item preview-full-width">
<div class="preview-label">Address</div>
<div class="preview-value" id="previewAddress"></div>
</div>
<div class="preview-item preview-full-width">
<div class="preview-label">Total Money Record History</div>
<div class="preview-value" id="previewMoneyHistory"></div>
</div>
<div class="preview-item preview-full-width">
<div class="preview-label">Linked Case</div>
<div class="preview-value" id="previewLinkedCase"></div>
</div>
<div class="preview-item preview-full-width">
<div class="preview-label">Special Judgement of this Case</div>
<div class="preview-value" id="previewSpecialJudgement" style="white-space: pre-wrap;"></div>
</div>
<div class="preview-item preview-full-width">
<div class="preview-label">Gist / Note</div>
<div class="preview-value" id="previewDetails" style="white-space: pre-wrap;"></div>
</div>
<div class="preview-item preview-full-width">
<div class="preview-label">Client Photo</div>
<div class="image-preview" id="previewPhoto"><small class="text-muted">No photo uploaded</small></div>
</div>
<div class="preview-item preview-full-width">
<div class="preview-label">Client Signature</div>
<div class="signature-preview" id="previewSignature"><small class="text-muted">No signature uploaded</small></div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
<button class="btn btn-primary" id="btnConfirmSave" type="button">Confirm & Save</button>
</div>
</div>
</div>
</div>

<div aria-hidden="true" aria-labelledby="taskModalLabel" class="modal fade" id="taskModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="taskModalLabel">Add New Task</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="taskForm">
<input id="taskId" type="hidden"/>
<div class="mb-3">
<label class="form-label">Date <span class="text-danger">*</span></label>
<input class="form-control" id="taskDate" required="" type="date"/>
</div>
<div class="mb-3">
<label class="form-label">Task Note <span class="text-danger">*</span></label>
<textarea class="form-control" id="taskNote" required="" rows="3"></textarea>
</div>
<div class="mb-3">
<label class="form-label">Priority <span class="text-danger">*</span></label>
<select class="form-select" id="taskPriority" required="">
<option>Low</option>
<option selected="">Medium</option>
<option>High</option>
</select>
</div>
<div class="mb-3 form-check">
<input class="form-check-input" id="taskCompleted" type="checkbox"/>
<label class="form-check-label" for="taskCompleted">Completed</label>
</div>
<div class="d-flex justify-content-end gap-2">
<button class="btn btn-danger" id="btnDeleteTask" style="display:none;" type="button">Delete</button>
<button class="btn btn-primary" id="btnSaveTask" type="submit">Save Task</button>
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
</div>
</form>
</div>
</div>
</div>
</div>

<div aria-hidden="true" aria-labelledby="taskDetailModalLabel" class="modal fade" id="taskDetailModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="taskDetailModalLabel">Task Details</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body task-modal-content">
<div class="task-detail-item">
<div class="task-detail-label">Date</div>
<div class="task-detail-value" id="detailTaskDate"></div>
</div>
<div class="task-detail-item">
<div class="task-detail-label">Note</div>
<div class="task-detail-value" id="detailTaskNote" style="white-space: pre-wrap;"></div>
</div>
<div class="task-detail-item">
<div class="task-detail-label">Priority</div>
<div class="task-detail-value" id="detailTaskPriority"></div>
</div>
<div class="task-detail-item">
<div class="task-detail-label">Status</div>
<div class="task-detail-value" id="detailTaskStatus"></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
<button class="btn btn-primary" id="btnEditTask" type="button">Edit Task</button>
<button class="btn btn-danger" id="btnDeleteTaskDetail" type="button">Delete Task</button>
</div>
</div>
</div>
</div>

<div aria-hidden="true" aria-labelledby="reminderModalLabel" class="modal fade" id="reminderModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="reminderModalLabel">Add New Reminder</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="reminderForm">
<input id="reminderId" type="hidden"/>
<div class="mb-3">
<label class="form-label">Date <span class="text-danger">*</span></label>
<input class="form-control" id="reminderDate" required="" type="date"/>
</div>
<div class="mb-3">
<label class="form-label">Time (Optional)</label>
<input class="form-control" id="reminderTime" type="time"/>
</div>
<div class="mb-3">
<label class="form-label">Reminder Note <span class="text-danger">*</span></label>
<textarea class="form-control" id="reminderNote" required="" rows="3"></textarea>
</div>
<div class="d-flex justify-content-end gap-2">
<button class="btn btn-danger" id="btnDeleteReminder" style="display:none;" type="button">Delete</button>
<button class="btn btn-primary" id="btnSaveReminder" type="submit">Save Reminder</button>
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
</div>
</form>
</div>
</div>
</div>
</div>

<div aria-hidden="true" aria-labelledby="dayEventsModalLabel" class="modal fade" id="dayEventsModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="dayEventsModalLabel">Events on <span id="eventDayDate"></span></h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<ul class="list-group list-group-flush" id="dayEventsList">
</ul>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
</div>
</div>
</div>
</div>

<div aria-hidden="true" aria-labelledby="caseTypeModalLabel" class="modal fade" id="caseTypeModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="caseTypeModalLabel">Add Case Type</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="caseTypeForm">
<div class="mb-3">
<label class="form-label">Case Type Name</label>
<input class="form-control" id="caseTypeName" required="" type="text">
</div>
<div class="text-end">
<button class="btn btn-primary" id="btnSaveCaseType" type="submit">Save</button>
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
</div>
</form>
</div>
</div>
</div>
</div>
<div aria-hidden="true" aria-labelledby="courtModalLabel" class="modal fade" id="courtModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="courtModalLabel">Add Court / Authority</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="courtForm">
<div class="mb-3">
<label class="form-label">Court Name</label>
<input class="form-control" id="courtName" required="" type="text">
</div>
<div class="text-end">
<button class="btn btn-primary" id="btnSaveCourt" type="submit">Save</button>
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
</div>
</form>
</div>
</div>
</div>
</div>

<div aria-hidden="true" aria-labelledby="documentDetailModalLabel" class="modal fade" id="documentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentDetailModalLabel">Document Details</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4">Title:</dt>
                    <dd class="col-sm-8" id="modalDocTitle"></dd>
                    <dt class="col-sm-4">Type:</dt>
                    <dd class="col-sm-8" id="modalDocType"></dd>
                    <dt class="col-sm-4">File Name:</dt>
                    <dd class="col-sm-8" id="modalDocFilename"></dd>
                    <dt class="col-sm-4">Date Uploaded:</dt>
                    <dd class="col-sm-8" id="modalDocDate"></dd>
                    <dt class="col-sm-4">Notes:</dt>
                    <dd class="col-sm-8" id="modalDocNotes" style="white-space: pre-wrap;"></dd>
                </dl>
                <div class="text-center mt-3">
                    <button class="btn btn-success" id="btnDownloadDocument"><i class="fas fa-download me-2"></i> Download File</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="btnDeleteDocument" type="button">Delete Document</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode.js/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// --- GLOBAL DATA STORE & UTILITIES ---
const DB_NAME = 'CaseManagerDB2025';
const DB_VERSION = 4;
let db;
let casesData = [];
let tasksData = [];
let remindersData = [];
let whatworkData = [];
let transactionsData = [];
let courtsData = [];
let caseTypesData = [];
let documentsData = [];

// Pagination defaults
const CASES_PER_PAGE = 10;
const WHATWORK_PER_PAGE = 10;
const TRANSACTION_PER_PAGE = 10;
let currentCasesPage = 1;
let currentWhatworkPage = 1;
let currentTransactionPage = 1;

// Charts
let statusChart, yearChart, courtChart, caseTypeReportChart, caseTypeDashboardChart;

// Modals
let caseDetailModal, previewModal, dayEventsModal, taskModal, reminderModal, courtModal, caseTypeModal, documentDetailModal, taskDetailModal;

// --- IndexedDB Initialization ---
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = (event) => {
            console.error("IndexedDB error:", event.target.error);
            alert("Error initializing database. Check console for details.");
            reject(event.target.error);
        };

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            // Create object stores if they don't exist
            if (!db.objectStoreNames.contains('cases')) {
                db.createObjectStore('cases', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('tasks')) {
                db.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('reminders')) {
                db.createObjectStore('reminders', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('whatwork')) {
                db.createObjectStore('whatwork', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('transactions')) {
                db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('courts')) {
                db.createObjectStore('courts', { keyPath: 'name' });
            }
            if (!db.objectStoreNames.contains('caseTypes')) {
                db.createObjectStore('caseTypes', { keyPath: 'name' });
            }
            if (!db.objectStoreNames.contains('documents')) {
                db.createObjectStore('documents', { keyPath: 'id', autoIncrement: true });
            }

            console.log(`DB upgraded to version ${DB_VERSION}`);
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            console.log("Database opened successfully");
            resolve();
        };
    });
}

// --- CRUD Operations (Generic) ---
function getAllData(storeName) {
    return new Promise((resolve, reject) => {
        if (!db) return reject("Database not initialized.");
        const transaction = db.transaction(storeName, 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = () => {
            resolve(request.result);
        };

        request.onerror = (event) => {
            console.error(`Error fetching data from ${storeName}:`, event.target.error);
            reject(event.target.error);
        };
    });
}

function putData(storeName, data) {
    return new Promise((resolve, reject) => {
        if (!db) return reject("Database not initialized.");
        const transaction = db.transaction(storeName, 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.put(data);

        request.onsuccess = () => {
            resolve(request.result);
        };

        request.onerror = (event) => {
            console.error(`Error saving data to ${storeName}:`, event.target.error);
            reject(event.target.error);
        };
    });
}

function deleteData(storeName, key) {
    return new Promise((resolve, reject) => {
        if (!db) return reject("Database not initialized.");
        const transaction = db.transaction(storeName, 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.delete(key);

        request.onsuccess = () => {
            resolve();
        };

        request.onerror = (event) => {
            console.error(`Error deleting data from ${storeName}:`, event.target.error);
            reject(event.target.error);
        };
    });
}

function clearStore(storeName) {
    return new Promise((resolve, reject) => {
        if (!db) return reject("Database not initialized.");
        const transaction = db.transaction(storeName, 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.clear();

        request.onsuccess = () => {
            resolve();
        };

        request.onerror = (event) => {
            console.error(`Error clearing ${storeName} store:`, event.target.error);
            reject(event.target.error);
        };
    });
}

// --- DATA INITIALIZATION & REFRESH ---
async function loadAllData() {
    try {
        casesData = await getAllData('cases');
        tasksData = await getAllData('tasks');
        remindersData = await getAllData('reminders');
        whatworkData = await getAllData('whatwork');
        transactionsData = await getAllData('transactions');
        courtsData = await getAllData('courts');
        caseTypesData = await getAllData('caseTypes');
        documentsData = await getAllData('documents');

        // Sort data
        casesData.sort((a, b) => {
            if (!a.nextHearing) return 1;
            if (!b.nextHearing) return -1;
            return new Date(a.nextHearing) - new Date(b.nextHearing);
        });
        tasksData.sort((a, b) => new Date(a.date) - new Date(b.date));
        remindersData.sort((a, b) => new Date(a.date) - new Date(b.date));
        whatworkData.sort((a, b) => new Date(b.date) - new Date(a.date));
        transactionsData.sort((a, b) => new Date(b.date) - new Date(a.date));
        documentsData.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));

        console.log("All data loaded successfully.");
    } catch (error) {
        console.error("Failed to load all data:", error);
    }
}

async function refreshUI() {
    await loadAllData();

    // 1. Dashboard
    updateDashboardCards();
    renderDashboardCaseTypeChart();
    renderDashboardCalendar();
    renderTasksList(tasksData, 'tasksBody', false);

    // 2. Cases
    currentCasesPage = 1;
    renderCasesTable(casesData);
    populateFilters();
    renderLinkedCaseOptions();

    // 3. Calendar
    renderBigCalendar();

    // 4. Reports
    renderAllCharts();

    // 5. Tasks
    renderTasksList(tasksData, 'tasksTableBody', true);

    // 6. Upcoming Cases
    renderUpcomingCases();

    // 7. Reminders
    renderRemindersList();
    renderRemindersCalendar();

    // 8. What Work Today
    currentWhatworkPage = 1;
    renderWhatworkTable();

    // 9. Transactions
    currentTransactionPage = 1;
    renderTransactionSummary();
    renderTransactionTable();
    
    // 10. Documents
    renderDocumentsTable('JUDGEMENT');
    renderDocumentsTable('LAW');
    renderDocumentsTable('FORM');
}

// --- UTILITIES ---

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString.includes('T') ? dateString : dateString + 'T00:00:00');
    if (isNaN(date)) return 'Invalid Date';
    return date.toLocaleDateString('en-IN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function getPriorityClass(priority) {
    switch (priority) {
        case 'High': return 'task-priority-high';
        case 'Medium': return 'task-priority-medium';
        case 'Low': return 'task-priority-low';
        default: return '';
    }
}

function formatCurrency(amount) {
    const formatter = new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 2,
    });
    return formatter.format(amount);
}

function generateQRCode(text, elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = '';

        if (typeof QRCode !== 'undefined') {
            new QRCode(element, {
                text: text,
                width: 100,
                height: 100,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        } else {
            element.innerHTML = '<small class="text-danger">QR Code library not loaded.</small>';
        }
    }
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        
        const MAX_SIZE = 5 * 1024 * 1024;
        if (file.size > MAX_SIZE) {
            alert(`File size exceeds limit (${MAX_SIZE / 1024 / 1024}MB). Please select a smaller file.`);
            return reject(new Error("File size limit exceeded."));
        }
        
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
    });
}

// --- SIDEBAR & NAVIGATION ---

function setActiveSection(targetId) {
    const titleMap = {
        'dashboard': 'Dashboard',
        'cases': 'All Cases',
        'add': 'Add Client / Case',
        'calendar': 'Calendar',
        'reports': 'Reports',
        'tasks': 'Tasks',
        'upcoming': 'Upcoming Cases',
        'reminders': 'Reminders',
        'whatwork': 'What work today',
        'judgement': 'Judgements Archive',
        'law': 'Statutes / Law Library',
        'formfile': 'General Forms / Files',
        'transactions': 'Daily Transaction',
        'backup': 'Backup & Restore',
    };
    document.querySelector('.main-title').textContent = titleMap[targetId] || 'Case Manager';

    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    const activeLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
    }

    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });
    const activeSection = document.getElementById(`${targetId}Section`);
     if (activeSection) {
        activeSection.style.display = 'block';
    }

    if (window.innerWidth <= 991) {
        document.getElementById('sidebar').classList.remove('show');
    }
    
    if (targetId === 'calendar') renderBigCalendar();
    if (targetId === 'reports') renderAllCharts();
    if (targetId === 'reminders') renderRemindersCalendar();
}

document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('data-target');
        setActiveSection(targetId);
    });
});

document.getElementById('toggleSidebar').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('show');
});

// --- DASHBOARD FUNCTIONS ---
function updateDashboardCards() {
    const activeCases = casesData.filter(c => c.status === 'Active').length;
    const courtsCount = new Set(casesData.map(c => c.court)).size;
    const upcomingHearings = casesData.filter(c => c.nextHearing && new Date(c.nextHearing) >= new Date()).length;
    const totalTasks = tasksData.length;
    const totalReminders = remindersData.length;

    document.getElementById('cardTotal').textContent = casesData.length;
    document.getElementById('cardActive').textContent = activeCases;
    document.getElementById('cardUpcoming').textContent = upcomingHearings;
    document.getElementById('cardCourts').textContent = courtsCount;
    document.getElementById('cardTasks').textContent = totalTasks;
    document.getElementById('cardReminders').textContent = totalReminders;
}

function renderDashboardCaseTypeChart() {
    const ctx = document.getElementById('caseTypeDashboardChart').getContext('2d');
    if (caseTypeDashboardChart) {
        caseTypeDashboardChart.destroy();
    }

    const caseTypeCounts = casesData.reduce((acc, caseItem) => {
        acc[caseItem.caseType || 'N/A'] = (acc[caseItem.caseType || 'N/A'] || 0) + 1;
        return acc;
    }, {});

    const labels = Object.keys(caseTypeCounts).filter(k => k);
    const data = Object.values(caseTypeCounts).filter((_, i) => labels[i]);

    const backgroundColors = [
        '#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#0ea5e9',
        '#374151', '#7c3aed', '#d946ef', '#f43f5e', '#a8a29e'
    ];

    caseTypeDashboardChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors.slice(0, labels.length),
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: false,
                },
            }
        }
    });
}

// --- CASES SECTION (Filter/Search/Table) ---
function populateFilters() {
    const courtSelect = document.getElementById('filterCourt');
    const yearSelect = document.getElementById('filterYear');

    Array.from(courtSelect.options).slice(1).forEach(option => option.remove());
    Array.from(yearSelect.options).slice(1).forEach(option => option.remove());

    const uniqueCourts = [...new Set(casesData.map(c => c.court).filter(c => c))].sort();
    uniqueCourts.forEach(court => {
        const option = document.createElement('option');
        option.value = court;
        option.textContent = court;
        courtSelect.appendChild(option);
    });

    const uniqueYears = [...new Set(casesData.map(c => c.year).filter(y => y))].sort((a, b) => b - a);
    uniqueYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    });
}

function filterAndSearchCases() {
    const courtFilter = document.getElementById('filterCourt').value;
    const yearFilter = document.getElementById('filterYear').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const searchInput = document.getElementById('searchInput').value.toLowerCase();

    let filteredCases = casesData.filter(caseItem => {
        if (courtFilter && caseItem.court !== courtFilter) return false;
        if (yearFilter && caseItem.year.toString() !== yearFilter) return false;
        if (statusFilter && caseItem.status !== statusFilter) return false;
        if (searchInput) {
            const searchFields = [
                caseItem.caseNo, caseItem.parties, caseItem.contact, caseItem.address,
                caseItem.court, caseItem.caseType, caseItem.cnr, caseItem.clientType,
                caseItem.details, caseItem.specialJudgement, caseItem.purpose, caseItem.advocateDetails
            ];
            const isMatch = searchFields.some(field => field && field.toString().toLowerCase().includes(searchInput));
            if (!isMatch) return false;
        }
        return true;
    });

    currentCasesPage = 1;
    renderCasesTable(filteredCases);
}

document.getElementById('filterCourt').addEventListener('change', filterAndSearchCases);
document.getElementById('filterYear').addEventListener('change', filterAndSearchCases);
document.getElementById('filterStatus').addEventListener('change', filterAndSearchCases);
document.getElementById('btnSearch').addEventListener('click', filterAndSearchCases);
document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        filterAndSearchCases();
    }
});

function renderCasesTable(data) {
    const tableBody = document.querySelector('#casesTable tbody');
    const casesCountElement = document.getElementById('casesCount');
    const paginationElement = document.getElementById('pagination');

    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No cases found matching the criteria.</td></tr>';
        casesCountElement.textContent = '0 cases';
        paginationElement.innerHTML = '';
        return;
    }

    const totalPages = Math.ceil(data.length / CASES_PER_PAGE);
    const start = (currentCasesPage - 1) * CASES_PER_PAGE;
    const end = start + CASES_PER_PAGE;
    const pageData = data.slice(start, end);

    tableBody.innerHTML = pageData.map(caseItem => `
        <tr data-id="${caseItem.id}">
            <td>${caseItem.caseType || 'N/A'}</td>
            <td>${caseItem.caseNo || 'N/A'}</td>
            <td>${caseItem.year || 'N/A'}</td>
            <td>${caseItem.court || 'N/A'}</td>
            <td class="text-truncate" title="${caseItem.parties || ''}">${caseItem.parties || 'N/A'}</td>
            <td>${formatDate(caseItem.nextHearing)}</td>
            <td>${caseItem.contact || 'N/A'}</td>
            <td class="text-truncate" title="${caseItem.address || ''}">${caseItem.address || 'N/A'}</td>
            <td>
                <button class="btn btn-sm btn-info btn-view-case" data-id="${caseItem.id}" title="View Details"><i class="fas fa-eye"></i></button>
            </td>
        </tr>
    `).join('');

    casesCountElement.textContent = `${data.length} cases`;

    renderPagination(paginationElement, totalPages, currentCasesPage, (page) => {
        currentCasesPage = page;
        renderCasesTable(data);
    });

    document.querySelectorAll('.btn-view-case').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            viewCaseDetails(id);
        });
    });
}

function renderPagination(container, totalPages, currentPage, pageChangeCallback) {
    container.innerHTML = '';

    if (totalPages <= 1) return;

    const createPageItem = (text, page, isActive, isDisabled) => {
        const li = document.createElement('li');
        li.className = `page-item ${isActive ? 'active' : ''} ${isDisabled ? 'disabled' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = text;
        if (!isDisabled && !isActive) {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                pageChangeCallback(page);
            });
        }
        li.appendChild(a);
        return li;
    };

    container.appendChild(createPageItem('Prev', currentPage - 1, false, currentPage === 1));

    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);

    if (currentPage <= 3) endPage = Math.min(totalPages, 5);
    if (currentPage > totalPages - 3) startPage = Math.max(1, totalPages - 4);

    if (startPage > 1) {
        container.appendChild(createPageItem('1', 1, false, false));
        if (startPage > 2) {
            container.appendChild(createPageItem('...', startPage - 1, false, true));
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        container.appendChild(createPageItem(i.toString(), i, i === currentPage, false));
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            container.appendChild(createPageItem('...', endPage + 1, false, true));
        }
        container.appendChild(createPageItem(totalPages.toString(), totalPages, false, false));
    }

    container.appendChild(createPageItem('Next', currentPage + 1, false, currentPage === totalPages));
}

// --- ADD/EDIT CASE SECTION ---

function populateCourtOptions() {
    const selectElements = [
        document.getElementById('court'),
        document.getElementById('filterCourt'),
    ];

    selectElements.forEach(select => {
        const currentValue = select.value;
        const optionsToKeep = select.options[0] ? [select.options[0]] : [];
        select.innerHTML = '';
        optionsToKeep.forEach(opt => select.appendChild(opt.cloneNode(true)));
        if (select.id !== 'filterCourt' && !select.options[0]) {
             const defaultOption = document.createElement('option');
             defaultOption.value = '';
             defaultOption.textContent = '-- Select Court --';
             select.appendChild(defaultOption);
        }

        courtsData.sort((a, b) => a.name.localeCompare(b.name)).forEach(court => {
            const option = document.createElement('option');
            option.value = court.name;
            option.textContent = court.name;
            select.appendChild(option);
        });
        if (currentValue) {
            select.value = currentValue;
        }
    });
}

function populateCaseTypeOptions() {
    const selectElements = [
        document.getElementById('caseType'),
    ];

    selectElements.forEach(select => {
        const currentValue = select.value;
        const optionsToKeep = select.options[0] ? [select.options[0]] : [];
        select.innerHTML = '';
        optionsToKeep.forEach(opt => select.appendChild(opt.cloneNode(true)));
        if (!select.options[0]) {
             const defaultOption = document.createElement('option');
             defaultOption.value = '';
             defaultOption.textContent = '-- Select Case Type --';
             select.appendChild(defaultOption);
        }

        caseTypesData.sort((a, b) => a.name.localeCompare(b.name)).forEach(type => {
            const option = document.createElement('option');
            option.value = type.name;
            option.textContent = type.name;
            select.appendChild(option);
        });

        if (currentValue) {
            select.value = currentValue;
        }
    });
}

async function renderLinkedCaseOptions() {
    const linkedCaseSelect = document.getElementById('linkedCase');
    const currentValue = linkedCaseSelect.value;
    
    linkedCaseSelect.innerHTML = '<option value="">-- Select Linked Case --</option>';

    const currentCaseId = document.getElementById('caseId').value ? parseInt(document.getElementById('caseId').value) : null;
    const otherCases = casesData.filter(c => c.id !== currentCaseId);

    otherCases.sort((a, b) => {
        const aText = `${a.caseNo || ''}/${a.year || ''} (${a.parties || 'N/A'})`;
        const bText = `${b.caseNo || ''}/${b.year || ''} (${b.parties || 'N/A'})`;
        return aText.localeCompare(bText);
    }).forEach(caseItem => {
        const option = document.createElement('option');
        option.value = caseItem.id;
        option.textContent = `${caseItem.caseNo}/${caseItem.year} (${caseItem.parties || 'N/A'})`;
        linkedCaseSelect.appendChild(option);
    });

    if (currentValue) {
        linkedCaseSelect.value = currentValue;
    }
}

function clearCaseForm() {
    document.getElementById('caseForm').reset();
    document.getElementById('caseId').value = '';
    document.getElementById('photo').value = '';
    document.getElementById('signature').value = '';
    document.getElementById('documentUpload').value = '';

    document.getElementById('photoPreview').innerHTML = '<small class="text-muted">Preview</small>';
    document.getElementById('signaturePreview').innerHTML = '<small class="text-muted">Preview</small>';
    document.getElementById('inlineQr').innerHTML = '';
    
    document.getElementById('saveBtn').textContent = 'Add Case';
    document.getElementById('saveBtn').classList.remove('btn-success');
    document.getElementById('saveBtn').classList.add('btn-primary');
    
    document.getElementById('court').value = '';
    document.getElementById('caseType').value = '';
    document.getElementById('priority').value = 'Medium';
    document.getElementById('status').value = 'Active';
    document.getElementById('injunction').value = 'No';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('nextHearing').value = today;
    document.getElementById('filingDate').value = today;

    renderLinkedCaseOptions();
}

function displayImagePreview(file, previewElementId) {
    const preview = document.getElementById(previewElementId);
    preview.innerHTML = '';

    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = '<small class="text-muted">Preview</small>';
    }
}

document.getElementById('photo').addEventListener('change', (e) => {
    displayImagePreview(e.target.files[0], 'photoPreview');
});

document.getElementById('signature').addEventListener('change', (e) => {
    displayImagePreview(e.target.files[0], 'signaturePreview');
});

document.getElementById('caseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveCase();
});

document.getElementById('clearBtn').addEventListener('click', clearCaseForm);

document.getElementById('previewBtn').addEventListener('click', showCasePreview);

document.getElementById('btnConfirmSave').addEventListener('click', async () => {
    previewModal.hide();
    await saveCase();
});

async function saveCase() {
    const caseId = document.getElementById('caseId').value ? parseInt(document.getElementById('caseId').value) : null;

    const photoFile = document.getElementById('photo').files[0];
    const signatureFile = document.getElementById('signature').files[0];
    const documentFiles = document.getElementById('documentUpload').files;
    let photoBase64 = document.getElementById('photoPreview').querySelector('img')?.src;
    let signatureBase64 = document.getElementById('signaturePreview').querySelector('img')?.src;
    const existingCase = caseId ? casesData.find(c => c.id === caseId) : null;

    if (!photoFile && existingCase) { photoBase64 = existingCase.photo; }
    if (!signatureFile && existingCase) { signatureBase64 = existingCase.signature; }

    if (photoFile) { photoBase64 = await fileToBase64(photoFile); }
    if (signatureFile) { signatureBase64 = await fileToBase64(signatureFile); }

    const newDocumentBase64 = [];
    for (let i = 0; i < documentFiles.length; i++) {
        const file = documentFiles[i];
        const base64 = await fileToBase64(file);
        if (base64) {
            newDocumentBase64.push({
                name: file.name,
                content: base64,
                mimeType: file.type,
                date: new Date().toISOString().split('T')[0]
            });
        }
    }
    
    const existingDocuments = existingCase ? (existingCase.documents || []) : [];
    const allDocuments = existingDocuments.concat(newDocumentBase64);

    const newCase = {
        court: document.getElementById('court').value,
        caseType: document.getElementById('caseType').value,
        caseNo: document.getElementById('caseNo').value.trim(),
        year: document.getElementById('year').value.trim(),
        parties: document.getElementById('parties').value.trim(),
        clientType: document.getElementById('clientType').value,
        contact: document.getElementById('contact').value.trim(),
        injunction: document.getElementById('injunction').value,
        priority: document.getElementById('priority').value,
        cnr: document.getElementById('cnr').value.trim(),
        filingDate: document.getElementById('filingDate').value,
        nextHearing: document.getElementById('nextHearing').value,
        status: document.getElementById('status').value,
        address: document.getElementById('address').value.trim(),
        moneyHistory: document.getElementById('moneyHistory').value.trim(),
        linkedCase: document.getElementById('linkedCase').value,
        purpose: document.getElementById('purpose').value.trim(),
        advocateDetails: document.getElementById('advocateDetails').value.trim(),
        extraNote: document.getElementById('extraNote').value.trim(),
        specialJudgement: document.getElementById('specialJudgement').value.trim(),
        details: document.getElementById('details').value.trim(),
        photo: photoBase64 || '',
        signature: signatureBase64 || '',
        documents: allDocuments,
        hearingHistory: existingCase ? existingCase.hearingHistory || [] : [],
        qrCodeContent: `${document.getElementById('caseNo').value.trim()}/${document.getElementById('year').value.trim()} - ${document.getElementById('parties').value.trim()}`
    };

    if (caseId) {
        newCase.id = caseId;
    }

    try {
        await putData('cases', newCase);
        alert(`Case ${newCase.caseNo}/${newCase.year} saved successfully!`);
        clearCaseForm();
        await refreshUI();
        setActiveSection('cases');
    } catch (error) {
        console.error("Error saving case:", error);
        alert("Failed to save case. See console for details.");
    }
}

function getCaseTextById(id) {
    const caseItem = casesData.find(c => c.id === id);
    if (caseItem) {
        return `${caseItem.caseNo}/${caseItem.year} (${caseItem.parties || 'N/A'})`;
    }
    return 'Case not found';
}

function showCasePreview() {
    document.getElementById('previewCourt').textContent = document.getElementById('court').value || 'N/A';
    document.getElementById('previewCaseType').textContent = document.getElementById('caseType').value || 'N/A';
    document.getElementById('previewCaseNoYear').textContent = `${document.getElementById('caseNo').value || 'N/A'}/${document.getElementById('year').value || 'N/A'}`;
    document.getElementById('previewParties').textContent = document.getElementById('parties').value || 'N/A';
    document.getElementById('previewClientType').textContent = document.getElementById('clientType').value || 'N/A';
    document.getElementById('previewContact').textContent = document.getElementById('contact').value || 'N/A';
    document.getElementById('previewNextHearing').textContent = formatDate(document.getElementById('nextHearing').value);
    document.getElementById('previewStatus').textContent = document.getElementById('status').value || 'N/A';
    document.getElementById('previewCNR').textContent = document.getElementById('cnr').value || 'N/A';
    document.getElementById('previewFilingDate').textContent = formatDate(document.getElementById('filingDate').value);
    document.getElementById('previewInjunction').textContent = document.getElementById('injunction').value || 'N/A';
    document.getElementById('previewPriority').textContent = document.getElementById('priority').value || 'N/A';
    document.getElementById('previewPurpose').textContent = document.getElementById('purpose').value || 'N/A';
    document.getElementById('previewAdvocateDetails').textContent = document.getElementById('advocateDetails').value || 'N/A';
    document.getElementById('previewExtraNote').textContent = document.getElementById('extraNote').value || 'N/A';
    document.getElementById('previewAddress').textContent = document.getElementById('address').value || 'N/A';
    document.getElementById('previewMoneyHistory').textContent = document.getElementById('moneyHistory').value || 'N/A';
    document.getElementById('previewLinkedCase').textContent = document.getElementById('linkedCase').value ? getCaseTextById(parseInt(document.getElementById('linkedCase').value)) : 'N/A';
    document.getElementById('previewSpecialJudgement').textContent = document.getElementById('specialJudgement').value || 'N/A';
    document.getElementById('previewDetails').textContent = document.getElementById('details').value || 'N/A';

    const photoFile = document.getElementById('photo').files[0];
    const signatureFile = document.getElementById('signature').files[0];
    const photoPreviewDiv = document.getElementById('previewPhoto');
    const signaturePreviewDiv = document.getElementById('previewSignature');

    photoPreviewDiv.innerHTML = '';
    signaturePreviewDiv.innerHTML = '';

    const renderPreviewImage = (file, existingSrc, previewDiv, fallbackText) => {
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                previewDiv.appendChild(img);
            };
            reader.readAsDataURL(file);
        } else if (existingSrc) {
            const img = document.createElement('img');
            img.src = existingSrc;
            previewDiv.appendChild(img);
        } else {
            previewDiv.innerHTML = `<small class="text-muted">${fallbackText}</small>`;
        }
    };

    const existingCase = document.getElementById('caseId').value ? casesData.find(c => c.id === parseInt(document.getElementById('caseId').value)) : null;

    renderPreviewImage(photoFile, existingCase?.photo, photoPreviewDiv, 'No photo uploaded');
    renderPreviewImage(signatureFile, existingCase?.signature, signaturePreviewDiv, 'No signature uploaded');

    previewModal.show();
}

// --- CASE DETAIL & ACTIONS ---

function viewCaseDetails(id) {
    const caseItem = casesData.find(c => c.id === id);
    if (!caseItem) {
        alert("Case not found.");
        return;
    }

    document.getElementById('modalCaseNo').textContent = `${caseItem.caseNo}/${caseItem.year}`;
    document.getElementById('modalCourt').textContent = caseItem.court || 'N/A';
    document.getElementById('modalCaseType').textContent = caseItem.caseType || 'N/A';
    document.getElementById('modalCaseNumYear').textContent = `${caseItem.caseNo || 'N/A'}/${caseItem.year || 'N/A'}`;
    document.getElementById('modalParties').textContent = caseItem.parties || 'N/A';
    document.getElementById('modalClientType').textContent = caseItem.clientType || 'N/A';
    document.getElementById('modalFilingDate').textContent = formatDate(caseItem.filingDate);
    document.getElementById('modalCNR').textContent = caseItem.cnr || 'N/A';
    document.getElementById('modalInjunction').textContent = caseItem.injunction || 'No';
    document.getElementById('modalContact').textContent = caseItem.contact || 'N/A';
    document.getElementById('modalAddress').textContent = caseItem.address || 'N/A';
    document.getElementById('modalMoneyHistory').textContent = caseItem.moneyHistory || 'N/A';
    document.getElementById('modalLinkedCase').textContent = caseItem.linkedCase ? getCaseTextById(parseInt(caseItem.linkedCase)) : 'N/A';
    document.getElementById('modalSpecialJudgement').textContent = caseItem.specialJudgement || 'N/A';
    document.getElementById('modalDetails').textContent = caseItem.details || 'N/A';
    document.getElementById('modalNextHearing').textContent = formatDate(caseItem.nextHearing);
    document.getElementById('modalPurpose').textContent = caseItem.purpose || 'N/A';
    document.getElementById('modalAdvocateDetails').textContent = caseItem.advocateDetails || 'N/A';
    document.getElementById('modalExtraNote').textContent = caseItem.extraNote || 'N/A';

    const priorityBadge = document.getElementById('modalPriorityBadge');
    priorityBadge.textContent = caseItem.priority || 'Medium';
    priorityBadge.className = `badge bg-${caseItem.priority === 'High' ? 'danger' : caseItem.priority === 'Medium' ? 'warning' : 'success'}`;

    const statusBadge = document.getElementById('modalStatusBadge');
    statusBadge.textContent = caseItem.status || 'Active';
    statusBadge.className = `badge bg-${caseItem.status === 'Active' ? 'primary' : caseItem.status === 'Pending' ? 'info' : caseItem.status === 'Closed' ? 'secondary' : 'dark'}`;

    const photoContainer = document.getElementById('modalPhotoContainer');
    const signatureContainer = document.getElementById('modalSignatureContainer');
    photoContainer.innerHTML = caseItem.photo ? `<img src="${caseItem.photo}" alt="Client Photo"/>` : '<small class="text-muted">Client Photo</small>';
    signatureContainer.innerHTML = caseItem.signature ? `<img src="${caseItem.signature}" alt="Client Signature"/>` : '<small class="text-muted">Client Signature</small>';

    if (caseItem.qrCodeContent) {
        generateQRCode(caseItem.qrCodeContent, 'modalQrCode');
    }

    renderHearingHistory(caseItem);

    document.getElementById('btnEditCase').onclick = () => editCase(id);
    document.getElementById('btnDeleteCase').onclick = () => deleteCase(id);
    document.getElementById('btnPrintCase').onclick = () => printCase(id);
    document.getElementById('exportCasePDF').onclick = () => exportCaseToPDF(id);

    document.getElementById('nextHearingForm').onsubmit = async (e) => {
        e.preventDefault();
        const newDate = document.getElementById('newNextHearing').value;
        if (newDate) {
            await addHearingHistory(caseItem, newDate);
        }
    };

    caseDetailModal.show();
}

function renderHearingHistory(caseItem) {
    const historyBody = document.getElementById('hearingHistoryBody');
    historyBody.innerHTML = '';

    if (!caseItem.hearingHistory || caseItem.hearingHistory.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hearing history found.</td></tr>';
        return;
    }

    caseItem.hearingHistory.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(history => {
        historyBody.innerHTML += `
            <tr>
                <td>${formatDate(history.date)}</td>
                <td>${history.details || 'N/A'}</td>
                <td><button class="btn btn-sm btn-outline-danger btn-delete-history" data-date="${history.date}"><i class="fas fa-trash-alt"></i></button></td>
            </tr>
        `;
    });

    document.querySelectorAll('.btn-delete-history').forEach(button => {
        button.addEventListener('click', async (e) => {
            const dateToDelete = e.currentTarget.getAttribute('data-date');
            if (confirm(`Are you sure you want to delete the history entry from ${formatDate(dateToDelete)}?`)) {
                await deleteHearingHistory(caseItem.id, dateToDelete);
            }
        });
    });
}

async function deleteHearingHistory(caseId, dateToDelete) {
    const caseItem = casesData.find(c => c.id === caseId);
    if (!caseItem) return;

    caseItem.hearingHistory = caseItem.hearingHistory.filter(h => h.date !== dateToDelete);

    try {
        await putData('cases', caseItem);
        await loadAllData();
        viewCaseDetails(caseId);
    } catch (error) {
        console.error("Error deleting hearing history:", error);
    }
}

async function addHearingHistory(caseItem, newNextHearingDate) {
    const currentCase = casesData.find(c => c.id === caseItem.id);
    if (!currentCase) {
        console.error("Case not found for update.");
        alert("Case not found for update.");
        return;
    }

    const newHistory = [...(currentCase.hearingHistory || [])];

    if (currentCase.nextHearing && new Date(currentCase.nextHearing) < new Date(newNextHearingDate)) {
        newHistory.push({
            date: currentCase.nextHearing,
            details: 'Previous Next Hearing Date/Adjournment'
        });
    }

    currentCase.nextHearing = newNextHearingDate;
    currentCase.hearingHistory = newHistory;

    try {
        await putData('cases', currentCase);
        alert(`Next hearing updated to ${formatDate(newNextHearingDate)} and previous date saved to history.`);
        document.getElementById('newNextHearing').value = '';
        await refreshUI();
        viewCaseDetails(currentCase.id);
    } catch (error) {
        console.error("Error updating hearing history:", error);
        alert("Failed to update next hearing.");
    }
}

function editCase(id) {
    const caseItem = casesData.find(c => c.id === id);
    if (!caseItem) return;

    document.getElementById('caseId').value = caseItem.id;
    document.getElementById('court').value = caseItem.court || '';
    document.getElementById('caseType').value = caseItem.caseType || '';
    document.getElementById('caseNo').value = caseItem.caseNo || '';
    document.getElementById('year').value = caseItem.year || '';
    document.getElementById('parties').value = caseItem.parties || '';
    document.getElementById('clientType').value = caseItem.clientType || '';
    document.getElementById('contact').value = caseItem.contact || '';
    document.getElementById('injunction').value = caseItem.injunction || 'No';
    document.getElementById('priority').value = caseItem.priority || 'Medium';
    document.getElementById('cnr').value = caseItem.cnr || '';
    document.getElementById('filingDate').value = caseItem.filingDate || '';
    document.getElementById('nextHearing').value = caseItem.nextHearing || '';
    document.getElementById('status').value = caseItem.status || 'Active';
    document.getElementById('address').value = caseItem.address || '';
    document.getElementById('moneyHistory').value = caseItem.moneyHistory || '';
    document.getElementById('linkedCase').value = caseItem.linkedCase || '';
    document.getElementById('purpose').value = caseItem.purpose || '';
    document.getElementById('advocateDetails').value = caseItem.advocateDetails || '';
    document.getElementById('extraNote').value = caseItem.extraNote || '';
    document.getElementById('specialJudgement').value = caseItem.specialJudgement || '';
    document.getElementById('details').value = caseItem.details || '';

    const photoPreview = document.getElementById('photoPreview');
    const signaturePreview = document.getElementById('signaturePreview');
    photoPreview.innerHTML = caseItem.photo ? `<img src="${caseItem.photo}" alt="Client Photo"/>` : '<small class="text-muted">Preview</small>';
    signaturePreview.innerHTML = caseItem.signature ? `<img src="${caseItem.signature}" alt="Client Signature"/>` : '<small class="text-muted">Preview</small>';

    if (caseItem.qrCodeContent) {
        generateQRCode(caseItem.qrCodeContent, 'inlineQr');
    }

    document.getElementById('saveBtn').textContent = 'Update Case';
    document.getElementById('saveBtn').classList.remove('btn-primary');
    document.getElementById('saveBtn').classList.add('btn-success');

    setActiveSection('add');
    caseDetailModal.hide();
}

async function deleteCase(id) {
    const caseItem = casesData.find(c => c.id === id);
    if (!caseItem) return;

    if (confirm(`Are you sure you want to delete case ${caseItem.caseNo}/${caseItem.year}? This action cannot be undone.`)) {
        try {
            await deleteData('cases', id);
            alert(`Case ${caseItem.caseNo}/${caseItem.year} deleted successfully.`);
            await refreshUI();
            caseDetailModal.hide();
        } catch (error) {
            console.error("Error deleting case:", error);
            alert("Failed to delete case.");
        }
    }
}

function printCase(id) {
    const caseItem = casesData.find(c => c.id === id);
    if (!caseItem) return;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Case Details: ${caseItem.caseNo}/${caseItem.year}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                .case-print-layout { width: 210mm; min-height: 297mm; padding: 15mm; margin: 0 auto; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                .case-print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #4f46e5; padding-bottom: 15px; }
                .case-print-section { margin-bottom: 20px; page-break-inside: avoid; }
                .case-print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                .case-print-field { margin-bottom: 10px; }
                .case-print-label { font-weight: 600; color: #4b5563; margin-bottom: 5px; }
                .case-print-value { padding: 8px; background: #f9fafb; border-radius: 4px; border-left: 3px solid #4f46e5; }
                .case-print-full-width { grid-column: 1 / -1; }
                .case-print-images { display: flex; justify-content: space-between; margin-top: 20px; }
                .case-print-image-container { width: 48%; text-align: center; }
                .case-print-image { max-width: 100%; max-height: 150px; border: 1px solid #e5e7eb; border-radius: 4px; padding: 5px; background: white; }
                @media print {
                    body { margin: 0; }
                    .case-print-layout { box-shadow: none; padding: 0; }
                }
            </style>
        </head>
        <body>
            <div class="case-print-layout">
                <div class="case-print-header">
                    <h1>Case Details</h1>
                    <h2>${caseItem.caseNo}/${caseItem.year}</h2>
                </div>
                <div class="case-print-section">
                    <div class="case-print-grid">
                        <div class="case-print-field">
                            <div class="case-print-label">Court / Authority</div>
                            <div class="case-print-value">${caseItem.court || 'N/A'}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">Case Type</div>
                            <div class="case-print-value">${caseItem.caseType || 'N/A'}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">Case No & Year</div>
                            <div class="case-print-value">${caseItem.caseNo || 'N/A'}/${caseItem.year || 'N/A'}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">Parties (Versus)</div>
                            <div class="case-print-value">${caseItem.parties || 'N/A'}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">My Client Status</div>
                            <div class="case-print-value">${caseItem.clientType || 'N/A'}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">Contact No.</div>
                            <div class="case-print-value">${caseItem.contact || 'N/A'}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">Next Hearing</div>
                            <div class="case-print-value">${formatDate(caseItem.nextHearing)}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">Status</div>
                            <div class="case-print-value">${caseItem.status || 'N/A'}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">CNR No.</div>
                            <div class="case-print-value">${caseItem.cnr || 'N/A'}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">Filing Date</div>
                            <div class="case-print-value">${formatDate(caseItem.filingDate)}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">Have Injunction</div>
                            <div class="case-print-value">${caseItem.injunction || 'No'}</div>
                        </div>
                        <div class="case-print-field">
                            <div class="case-print-label">Priority</div>
                            <div class="case-print-value">${caseItem.priority || 'Medium'}</div>
                        </div>
                        <div class="case-print-field case-print-full-width">
                            <div class="case-print-label">Purpose</div>
                            <div class="case-print-value">${caseItem.purpose || 'N/A'}</div>
                        </div>
                        <div class="case-print-field case-print-full-width">
                            <div class="case-print-label">Advocate / Farm Details</div>
                            <div class="case-print-value">${caseItem.advocateDetails || 'N/A'}</div>
                        </div>
                        <div class="case-print-field case-print-full-width">
                            <div class="case-print-label">Extra Note</div>
                            <div class="case-print-value">${caseItem.extraNote || 'N/A'}</div>
                        </div>
                        <div class="case-print-field case-print-full-width">
                            <div class="case-print-label">Address</div>
                            <div class="case-print-value">${caseItem.address || 'N/A'}</div>
                        </div>
                        <div class="case-print-field case-print-full-width">
                            <div class="case-print-label">Total Money Record History</div>
                            <div class="case-print-value">${caseItem.moneyHistory || 'N/A'}</div>
                        </div>
                        <div class="case-print-field case-print-full-width">
                            <div class="case-print-label">Linked Case</div>
                            <div class="case-print-value">${caseItem.linkedCase ? getCaseTextById(parseInt(caseItem.linkedCase)) : 'N/A'}</div>
                        </div>
                        <div class="case-print-field case-print-full-width">
                            <div class="case-print-label">Special Judgement of this Case</div>
                            <div class="case-print-value">${caseItem.specialJudgement || 'N/A'}</div>
                        </div>
                        <div class="case-print-field case-print-full-width">
                            <div class="case-print-label">Gist / Note</div>
                            <div class="case-print-value">${caseItem.details || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                ${(caseItem.photo || caseItem.signature) ? `
                <div class="case-print-section">
                    <div class="case-print-images">
                        ${caseItem.photo ? `
                        <div class="case-print-image-container">
                            <div class="case-print-label">Client Photo</div>
                            <img src="${caseItem.photo}" class="case-print-image" alt="Client Photo"/>
                        </div>
                        ` : ''}
                        ${caseItem.signature ? `
                        <div class="case-print-image-container">
                            <div class="case-print-label">Client Signature</div>
                            <img src="${caseItem.signature}" class="case-print-image" alt="Client Signature"/>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}

async function exportCaseToPDF(id) {
    const caseItem = casesData.find(c => c.id === id);
    if (!caseItem) return;

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Title
        doc.setFontSize(20);
        doc.text(`Case Details: ${caseItem.caseNo}/${caseItem.year}`, 20, 20);

        // Basic info
        doc.setFontSize(12);
        let y = 40;
        doc.text(`Court: ${caseItem.court || 'N/A'}`, 20, y);
        doc.text(`Case Type: ${caseItem.caseType || 'N/A'}`, 20, y + 10);
        doc.text(`Parties: ${caseItem.parties || 'N/A'}`, 20, y + 20);
        doc.text(`Next Hearing: ${formatDate(caseItem.nextHearing)}`, 20, y + 30);
        doc.text(`Status: ${caseItem.status || 'N/A'}`, 20, y + 40);

        // Add more details as needed...
        // This is a basic implementation - you can expand it to include all case details

        // Save the PDF
        doc.save(`Case_${caseItem.caseNo}_${caseItem.year}.pdf`);
    } catch (error) {
        console.error("Error generating PDF:", error);
        alert("Failed to generate PDF. Check console for details.");
    }
}

// --- TASKS ---
document.getElementById('btnAddTaskDashboard').addEventListener('click', () => {
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskDate').valueAsDate = new Date();
    document.getElementById('taskPriority').value = 'Medium';
    document.getElementById('taskCompleted').checked = false;
    document.getElementById('btnDeleteTask').style.display = 'none';
});

document.getElementById('btnAddTaskPage').addEventListener('click', () => {
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskDate').valueAsDate = new Date();
    document.getElementById('taskPriority').value = 'Medium';
    document.getElementById('taskCompleted').checked = false;
    document.getElementById('btnDeleteTask').style.display = 'none';
});

document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveTask();
});

async function saveTask() {
    const taskId = document.getElementById('taskId').value ? parseInt(document.getElementById('taskId').value) : null;

    const newTask = {
        date: document.getElementById('taskDate').value,
        note: document.getElementById('taskNote').value.trim(),
        priority: document.getElementById('taskPriority').value,
        completed: document.getElementById('taskCompleted').checked
    };

    if (taskId) {
        newTask.id = taskId;
    }

    try {
        await putData('tasks', newTask);
        taskModal.hide();
        await refreshUI();
    } catch (error) {
        console.error("Error saving task:", error);
        alert("Failed to save task.");
    }
}

function renderTasksList(tasks, tableBodyId, includeActions) {
    const tableBody = document.getElementById(tableBodyId);
    tableBody.innerHTML = '';

    if (tasks.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No tasks found.</td></tr>';
        return;
    }

    tableBody.innerHTML = tasks.map((task, index) => `
        <tr class="task-row ${getPriorityClass(task.priority)} ${task.completed ? 'task-completed' : ''}" data-id="${task.id}">
            <td>${index + 1}</td>
            <td>${formatDate(task.date)}</td>
            <td class="${task.completed ? 'text-decoration-line-through' : ''}">${task.note}</td>
            <td><span class="badge bg-${task.priority === 'High' ? 'danger' : task.priority === 'Medium' ? 'warning' : 'success'}">${task.priority}</span></td>
            ${includeActions ? `
            <td>
                <button class="btn btn-sm btn-info btn-view-task" data-id="${task.id}" title="View Details"><i class="fas fa-eye"></i></button>
                <button class="btn btn-sm btn-warning btn-edit-task" data-id="${task.id}" title="Edit Task"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger btn-delete-task" data-id="${task.id}" title="Delete Task"><i class="fas fa-trash-alt"></i></button>
            </td>
            ` : '<td></td>'}
        </tr>
    `).join('');

    if (includeActions) {
        document.querySelectorAll('.btn-view-task').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = parseInt(e.currentTarget.getAttribute('data-id'));
                viewTaskDetails(id);
            });
        });

        document.querySelectorAll('.btn-edit-task').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = parseInt(e.currentTarget.getAttribute('data-id'));
                editTask(id);
            });
        });

        document.querySelectorAll('.btn-delete-task').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = parseInt(e.currentTarget.getAttribute('data-id'));
                deleteTask(id);
            });
        });
    }
}

function viewTaskDetails(id) {
    const task = tasksData.find(t => t.id === id);
    if (!task) return;

    document.getElementById('detailTaskDate').textContent = formatDate(task.date);
    document.getElementById('detailTaskNote').textContent = task.note;
    document.getElementById('detailTaskPriority').textContent = task.priority;
    document.getElementById('detailTaskStatus').textContent = task.completed ? 'Completed' : 'Pending';

    document.getElementById('btnEditTask').onclick = () => {
        taskDetailModal.hide();
        editTask(id);
    };

    document.getElementById('btnDeleteTaskDetail').onclick = () => {
        taskDetailModal.hide();
        deleteTask(id);
    };

    taskDetailModal.show();
}

function editTask(id) {
    const task = tasksData.find(t => t.id === id);
    if (!task) return;

    document.getElementById('taskId').value = task.id;
    document.getElementById('taskDate').value = task.date;
    document.getElementById('taskNote').value = task.note;
    document.getElementById('taskPriority').value = task.priority;
    document.getElementById('taskCompleted').checked = task.completed;
    document.getElementById('btnDeleteTask').style.display = 'inline-block';

    taskModal.show();
}

async function deleteTask(id) {
    const task = tasksData.find(t => t.id === id);
    if (!task) return;

    if (confirm(`Are you sure you want to delete this task?`)) {
        try {
            await deleteData('tasks', id);
            await refreshUI();
            taskModal.hide();
            taskDetailModal.hide();
        } catch (error) {
            console.error("Error deleting task:", error);
            alert("Failed to delete task.");
        }
    }
}

// --- REMINDERS ---
document.getElementById('btnAddReminderPage').addEventListener('click', () => {
    document.getElementById('reminderForm').reset();
    document.getElementById('reminderId').value = '';
    document.getElementById('reminderDate').valueAsDate = new Date();
    document.getElementById('reminderTime').value = '';
    document.getElementById('btnDeleteReminder').style.display = 'none';
});

document.getElementById('reminderForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveReminder();
});

async function saveReminder() {
    const reminderId = document.getElementById('reminderId').value ? parseInt(document.getElementById('reminderId').value) : null;

    const newReminder = {
        date: document.getElementById('reminderDate').value,
        time: document.getElementById('reminderTime').value || null,
        note: document.getElementById('reminderNote').value.trim()
    };

    if (reminderId) {
        newReminder.id = reminderId;
    }

    try {
        await putData('reminders', newReminder);
        reminderModal.hide();
        await refreshUI();
    } catch (error) {
        console.error("Error saving reminder:", error);
        alert("Failed to save reminder.");
    }
}

function renderRemindersList() {
    const tableBody = document.getElementById('remindersTableBody');
    tableBody.innerHTML = '';

    if (remindersData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No reminders found.</td></tr>';
        return;
    }

    tableBody.innerHTML = remindersData.map((reminder, index) => `
        <tr data-id="${reminder.id}">
            <td>${index + 1}</td>
            <td>${formatDate(reminder.date)} ${reminder.time ? `at ${reminder.time}` : ''}</td>
            <td>${reminder.note}</td>
            <td>
                <button class="btn btn-sm btn-warning btn-edit-reminder" data-id="${reminder.id}" title="Edit Reminder"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger btn-delete-reminder" data-id="${reminder.id}" title="Delete Reminder"><i class="fas fa-trash-alt"></i></button>
            </td>
        </tr>
    `).join('');

    document.querySelectorAll('.btn-edit-reminder').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            editReminder(id);
        });
    });

    document.querySelectorAll('.btn-delete-reminder').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            deleteReminder(id);
        });
    });
}

function editReminder(id) {
    const reminder = remindersData.find(r => r.id === id);
    if (!reminder) return;

    document.getElementById('reminderId').value = reminder.id;
    document.getElementById('reminderDate').value = reminder.date;
    document.getElementById('reminderTime').value = reminder.time || '';
    document.getElementById('reminderNote').value = reminder.note;
    document.getElementById('btnDeleteReminder').style.display = 'inline-block';

    reminderModal.show();
}

async function deleteReminder(id) {
    const reminder = remindersData.find(r => r.id === id);
    if (!reminder) return;

    if (confirm(`Are you sure you want to delete this reminder?`)) {
        try {
            await deleteData('reminders', id);
            await refreshUI();
            reminderModal.hide();
        } catch (error) {
            console.error("Error deleting reminder:", error);
            alert("Failed to delete reminder.");
        }
    }
}

function renderRemindersCalendar() {
    const calendarEl = document.getElementById('remindersCalendar');
    if (!calendarEl) return;

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'en',
        height: 'auto',
        events: remindersData.map(reminder => ({
            title: reminder.note,
            start: reminder.date,
            allDay: !reminder.time,
            extendedProps: {
                time: reminder.time
            },
            backgroundColor: '#3b82f6',
            borderColor: '#3b82f6'
        })),
        eventClick: function(info) {
            const reminder = remindersData.find(r => 
                r.date === info.event.startStr && r.note === info.event.title
            );
            if (reminder) {
                alert(`Reminder: ${reminder.note}\nDate: ${formatDate(reminder.date)}\n${reminder.time ? `Time: ${reminder.time}` : ''}`);
            }
        },
        dateClick: function(info) {
            document.getElementById('reminderDate').value = info.dateStr;
            reminderModal.show();
        }
    });

    calendar.render();
}

// --- WHAT WORK TODAY ---
document.getElementById('whatworkForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveWhatwork();
});

document.getElementById('btnClearWhatwork').addEventListener('click', clearWhatworkForm);

document.getElementById('btnDeleteWhatwork').addEventListener('click', async () => {
    const id = document.getElementById('whatworkId').value;
    if (id) {
        await deleteWhatwork(parseInt(id));
    }
});

async function saveWhatwork() {
    const whatworkId = document.getElementById('whatworkId').value ? parseInt(document.getElementById('whatworkId').value) : null;

    const newWhatwork = {
        date: document.getElementById('whatworkDate').value,
        note: document.getElementById('whatworkNote').value.trim()
    };

    if (whatworkId) {
        newWhatwork.id = whatworkId;
    }

    try {
        await putData('whatwork', newWhatwork);
        clearWhatworkForm();
        await refreshUI();
    } catch (error) {
        console.error("Error saving what work entry:", error);
        alert("Failed to save entry.");
    }
}

function clearWhatworkForm() {
    document.getElementById('whatworkForm').reset();
    document.getElementById('whatworkId').value = '';
    document.getElementById('whatworkDate').valueAsDate = new Date();
    document.getElementById('btnDeleteWhatwork').style.display = 'none';
}

function renderWhatworkTable() {
    const tableBody = document.getElementById('whatworkTableBody');
    const whatworkCountElement = document.getElementById('whatworkCount');
    const whatworkFooterElement = document.getElementById('whatworkFooter');
    const paginationElement = document.getElementById('whatworkPagination');

    if (whatworkData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No entries found.</td></tr>';
        whatworkCountElement.textContent = '0 items';
        whatworkFooterElement.textContent = 'Showing 0';
        paginationElement.innerHTML = '';
        return;
    }

    const totalPages = Math.ceil(whatworkData.length / WHATWORK_PER_PAGE);
    const start = (currentWhatworkPage - 1) * WHATWORK_PER_PAGE;
    const end = start + WHATWORK_PER_PAGE;
    const pageData = whatworkData.slice(start, end);

    tableBody.innerHTML = pageData.map((item, index) => `
        <tr data-id="${item.id}">
            <td>${start + index + 1}</td>
            <td>${formatDate(item.date)}</td>
            <td>${item.note}</td>
            <td>
                <button class="btn btn-sm btn-warning btn-edit-whatwork" data-id="${item.id}" title="Edit Entry"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger btn-delete-whatwork" data-id="${item.id}" title="Delete Entry"><i class="fas fa-trash-alt"></i></button>
            </td>
        </tr>
    `).join('');

    whatworkCountElement.textContent = `${whatworkData.length} items`;
    whatworkFooterElement.textContent = `Showing ${start + 1} to ${Math.min(end, whatworkData.length)} of ${whatworkData.length} entries`;

    renderPagination(paginationElement, totalPages, currentWhatworkPage, (page) => {
        currentWhatworkPage = page;
        renderWhatworkTable();
    });

    document.querySelectorAll('.btn-edit-whatwork').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            editWhatwork(id);
        });
    });

    document.querySelectorAll('.btn-delete-whatwork').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            deleteWhatwork(id);
        });
    });
}

function editWhatwork(id) {
    const item = whatworkData.find(w => w.id === id);
    if (!item) return;

    document.getElementById('whatworkId').value = item.id;
    document.getElementById('whatworkDate').value = item.date;
    document.getElementById('whatworkNote').value = item.note;
    document.getElementById('btnDeleteWhatwork').style.display = 'inline-block';
}

async function deleteWhatwork(id) {
    const item = whatworkData.find(w => w.id === id);
    if (!item) return;

    if (confirm(`Are you sure you want to delete this entry?`)) {
        try {
            await deleteData('whatwork', id);
            await refreshUI();
        } catch (error) {
            console.error("Error deleting what work entry:", error);
            alert("Failed to delete entry.");
        }
    }
}

// --- TRANSACTIONS ---
document.getElementById('transactionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveTransaction();
});

document.getElementById('btnClearTransaction').addEventListener('click', clearTransactionForm);

document.getElementById('btnDeleteTransaction').addEventListener('click', async () => {
    const id = document.getElementById('transactionId').value;
    if (id) {
        await deleteTransaction(parseInt(id));
    }
});

function renderTransactionSummary() {
    const totalDeposit = transactionsData
        .filter(t => t.type === 'Deposit')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
    
    const totalExpense = transactionsData
        .filter(t => t.type === 'Expense')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
    
    const currentBalance = totalDeposit - totalExpense;

    document.getElementById('totalDeposit').textContent = formatCurrency(totalDeposit);
    document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
    document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
}

function renderTransactionTable() {
    const tableBody = document.getElementById('transactionTableBody');
    const transactionFooterElement = document.getElementById('transactionFooter');
    const paginationElement = document.getElementById('transactionPagination');

    if (transactionsData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No transactions found.</td></tr>';
        transactionFooterElement.textContent = 'Showing 0';
        paginationElement.innerHTML = '';
        return;
    }

    const totalPages = Math.ceil(transactionsData.length / TRANSACTION_PER_PAGE);
    const start = (currentTransactionPage - 1) * TRANSACTION_PER_PAGE;
    const end = start + TRANSACTION_PER_PAGE;
    const pageData = transactionsData.slice(start, end);

    tableBody.innerHTML = pageData.map((transaction, index) => `
        <tr data-id="${transaction.id}">
            <td>${formatDate(transaction.date)}</td>
            <td><span class="badge bg-${transaction.type === 'Deposit' ? 'success' : 'danger'}">${transaction.type}</span></td>
            <td>${transaction.description}</td>
            <td class="text-end fw-bold ${transaction.type === 'Deposit' ? 'text-success' : 'text-danger'}">${formatCurrency(parseFloat(transaction.amount))}</td>
            <td>
                <button class="btn btn-sm btn-warning btn-edit-transaction" data-id="${transaction.id}" title="Edit Transaction"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger btn-delete-transaction" data-id="${transaction.id}" title="Delete Transaction"><i class="fas fa-trash-alt"></i></button>
            </td>
        </tr>
    `).join('');

    transactionFooterElement.textContent = `Showing ${start + 1} to ${Math.min(end, transactionsData.length)} of ${transactionsData.length} transactions`;

    renderPagination(paginationElement, totalPages, currentTransactionPage, (page) => {
        currentTransactionPage = page;
        renderTransactionTable();
    });

    document.querySelectorAll('.btn-edit-transaction').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            editTransaction(id);
        });
    });

    document.querySelectorAll('.btn-delete-transaction').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            deleteTransaction(id);
        });
    });
}

async function saveTransaction() {
    const transactionId = document.getElementById('transactionId').value ? parseInt(document.getElementById('transactionId').value) : null;

    const newTransaction = {
        date: document.getElementById('transactionDate').value,
        type: document.getElementById('transactionType').value,
        amount: parseFloat(document.getElementById('transactionAmount').value).toFixed(2),
        description: document.getElementById('transactionDescription').value.trim()
    };

    if (transactionId) {
        newTransaction.id = transactionId;
    }

    try {
        await putData('transactions', newTransaction);
        clearTransactionForm();
        await refreshUI();
    } catch (error) {
        console.error("Error saving transaction:", error);
        alert("Failed to save transaction.");
    }
}

function clearTransactionForm() {
    document.getElementById('transactionForm').reset();
    document.getElementById('transactionId').value = '';
    document.getElementById('transactionDate').valueAsDate = new Date();
    document.getElementById('btnDeleteTransaction').style.display = 'none';
}

function editTransaction(id) {
    const transaction = transactionsData.find(t => t.id === id);
    if (!transaction) return;

    document.getElementById('transactionId').value = transaction.id;
    document.getElementById('transactionDate').value = transaction.date;
    document.getElementById('transactionType').value = transaction.type;
    document.getElementById('transactionAmount').value = transaction.amount;
    document.getElementById('transactionDescription').value = transaction.description;
    document.getElementById('btnDeleteTransaction').style.display = 'inline-block';
}

async function deleteTransaction(id) {
    const transaction = transactionsData.find(t => t.id === id);
    if (!transaction) return;

    if (confirm(`Are you sure you want to delete this transaction?`)) {
        try {
            await deleteData('transactions', id);
            await refreshUI();
        } catch (error) {
            console.error("Error deleting transaction:", error);
            alert("Failed to delete transaction.");
        }
    }
}

// --- CALENDAR ---
function renderDashboardCalendar() {
    const calendarEl = document.getElementById('dashboardCalendar');
    if (!calendarEl) return;

    const events = [];

    // Add case hearings
    casesData.filter(c => c.nextHearing).forEach(caseItem => {
        events.push({
            title: `${caseItem.caseNo}/${caseItem.year} - ${caseItem.parties || 'N/A'}`,
            start: caseItem.nextHearing,
            allDay: true,
            extendedProps: {
                type: 'case',
                id: caseItem.id
            },
            backgroundColor: '#4f46e5',
            borderColor: '#4f46e5'
        });
    });

    // Add tasks
    tasksData.filter(t => !t.completed).forEach(task => {
        events.push({
            title: `Task: ${task.note}`,
            start: task.date,
            allDay: true,
            extendedProps: {
                type: 'task',
                id: task.id
            },
            backgroundColor: '#10b981',
            borderColor: '#10b981'
        });
    });

    // Add reminders
    remindersData.forEach(reminder => {
        events.push({
            title: `Reminder: ${reminder.note}`,
            start: reminder.date,
            allDay: !reminder.time,
            extendedProps: {
                type: 'reminder',
                id: reminder.id
            },
            backgroundColor: '#f59e0b',
            borderColor: '#f59e0b'
        });
    });

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'en',
        height: 300,
        events: events,
        eventClick: function(info) {
            const event = info.event;
            const type = event.extendedProps.type;
            const id = event.extendedProps.id;

            if (type === 'case') {
                viewCaseDetails(id);
            } else if (type === 'task') {
                viewTaskDetails(id);
            } else if (type === 'reminder') {
                const reminder = remindersData.find(r => r.id === id);
                if (reminder) {
                    alert(`Reminder: ${reminder.note}\nDate: ${formatDate(reminder.date)}\n${reminder.time ? `Time: ${reminder.time}` : ''}`);
                }
            }
        }
    });

    calendar.render();
}

function renderBigCalendar() {
    const calendarEl = document.getElementById('bigCalendar');
    if (!calendarEl) return;

    const events = [];

    // Add case hearings
    casesData.filter(c => c.nextHearing).forEach(caseItem => {
        events.push({
            title: `Case: ${caseItem.caseNo}/${caseItem.year}`,
            start: caseItem.nextHearing,
            allDay: true,
            extendedProps: {
                type: 'case',
                id: caseItem.id,
                details: caseItem.parties || 'N/A'
            },
            backgroundColor: '#4f46e5',
            borderColor: '#4f46e5'
        });
    });

    // Add tasks
    tasksData.filter(t => !t.completed).forEach(task => {
        events.push({
            title: `Task: ${task.note}`,
            start: task.date,
            allDay: true,
            extendedProps: {
                type: 'task',
                id: task.id
            },
            backgroundColor: '#10b981',
            borderColor: '#10b981'
        });
    });

    // Add reminders
    remindersData.forEach(reminder => {
        events.push({
            title: `Reminder: ${reminder.note}`,
            start: reminder.date,
            allDay: !reminder.time,
            extendedProps: {
                type: 'reminder',
                id: reminder.id
            },
            backgroundColor: '#f59e0b',
            borderColor: '#f59e0b'
        });
    });

    // Add what work entries
    whatworkData.forEach(work => {
        events.push({
            title: `Work: ${work.note.substring(0, 30)}${work.note.length > 30 ? '...' : ''}`,
            start: work.date,
            allDay: true,
            extendedProps: {
                type: 'whatwork',
                id: work.id
            },
            backgroundColor: '#8b5cf6',
            borderColor: '#8b5cf6'
        });
    });

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'en',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events,
        dateClick: function(info) {
            showDayEvents(info.dateStr);
        },
        eventClick: function(info) {
            const event = info.event;
            const type = event.extendedProps.type;
            const id = event.extendedProps.id;

            if (type === 'case') {
                viewCaseDetails(id);
            } else if (type === 'task') {
                viewTaskDetails(id);
            } else if (type === 'reminder') {
                const reminder = remindersData.find(r => r.id === id);
                if (reminder) {
                    alert(`Reminder: ${reminder.note}\nDate: ${formatDate(reminder.date)}\n${reminder.time ? `Time: ${reminder.time}` : ''}`);
                }
            } else if (type === 'whatwork') {
                const work = whatworkData.find(w => w.id === id);
                if (work) {
                    alert(`Work Entry: ${work.note}\nDate: ${formatDate(work.date)}`);
                }
            }
        }
    });

    calendar.render();
}

function showDayEvents(dateStr) {
    const date = new Date(dateStr);
    const formattedDate = formatDate(dateStr);

    document.getElementById('eventDayDate').textContent = formattedDate;

    const eventsList = document.getElementById('dayEventsList');
    eventsList.innerHTML = '';

    const dayCases = casesData.filter(c => c.nextHearing === dateStr);
    const dayTasks = tasksData.filter(t => t.date === dateStr);
    const dayReminders = remindersData.filter(r => r.date === dateStr);
    const dayWhatwork = whatworkData.filter(w => w.date === dateStr);

    if (dayCases.length === 0 && dayTasks.length === 0 && dayReminders.length === 0 && dayWhatwork.length === 0) {
        eventsList.innerHTML = '<li class="list-group-item text-center text-muted">No events for this day.</li>';
    } else {
        dayCases.forEach(caseItem => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <div>
                    <strong>Case Hearing:</strong> ${caseItem.caseNo}/${caseItem.year} - ${caseItem.parties || 'N/A'}
                </div>
                <button class="btn btn-sm btn-info btn-view-case-day" data-id="${caseItem.id}">View</button>
            `;
            eventsList.appendChild(li);
        });

        dayTasks.forEach(task => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <div>
                    <strong>Task:</strong> ${task.note}
                    <span class="badge bg-${task.priority === 'High' ? 'danger' : task.priority === 'Medium' ? 'warning' : 'success'} ms-2">${task.priority}</span>
                    ${task.completed ? '<span class="badge bg-secondary ms-2">Completed</span>' : ''}
                </div>
                <button class="btn btn-sm btn-info btn-view-task-day" data-id="${task.id}">View</button>
            `;
            eventsList.appendChild(li);
        });

        dayReminders.forEach(reminder => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <div>
                    <strong>Reminder:</strong> ${reminder.note}
                    ${reminder.time ? `<small class="text-muted ms-2">at ${reminder.time}</small>` : ''}
                </div>
                <button class="btn btn-sm btn-info btn-view-reminder-day" data-id="${reminder.id}">View</button>
            `;
            eventsList.appendChild(li);
        });

        dayWhatwork.forEach(work => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <div>
                    <strong>Work Entry:</strong> ${work.note}
                </div>
                <button class="btn btn-sm btn-info btn-view-whatwork-day" data-id="${work.id}">View</button>
            `;
            eventsList.appendChild(li);
        });
    }

    document.querySelectorAll('.btn-view-case-day').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            dayEventsModal.hide();
            viewCaseDetails(id);
        });
    });

    document.querySelectorAll('.btn-view-task-day').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            dayEventsModal.hide();
            viewTaskDetails(id);
        });
    });

    document.querySelectorAll('.btn-view-reminder-day').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            dayEventsModal.hide();
            const reminder = remindersData.find(r => r.id === id);
            if (reminder) {
                alert(`Reminder: ${reminder.note}\nDate: ${formatDate(reminder.date)}\n${reminder.time ? `Time: ${reminder.time}` : ''}`);
            }
        });
    });

    document.querySelectorAll('.btn-view-whatwork-day').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            dayEventsModal.hide();
            const work = whatworkData.find(w => w.id === id);
            if (work) {
                alert(`Work Entry: ${work.note}\nDate: ${formatDate(work.date)}`);
            }
        });
    });

    dayEventsModal.show();
}

// --- REPORTS & CHARTS ---
function renderAllCharts() {
    renderStatusChart();
    renderYearChart();
    renderCourtChart();
    renderCaseTypeReportChart();
}

function renderStatusChart() {
    const ctx = document.getElementById('statusChart').getContext('2d');
    if (statusChart) {
        statusChart.destroy();
    }

    const statusCounts = casesData.reduce((acc, caseItem) => {
        acc[caseItem.status || 'Unknown'] = (acc[caseItem.status || 'Unknown'] || 0) + 1;
        return acc;
    }, {});

    statusChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(statusCounts),
            datasets: [{
                data: Object.values(statusCounts),
                backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#6b7280'],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Cases by Status'
                }
            }
        }
    });
}

function renderYearChart() {
    const ctx = document.getElementById('yearChart').getContext('2d');
    if (yearChart) {
        yearChart.destroy();
    }

    const yearCounts = casesData.reduce((acc, caseItem) => {
        const year = caseItem.year || 'Unknown';
        acc[year] = (acc[year] || 0) + 1;
        return acc;
    }, {});

    const sortedYears = Object.keys(yearCounts).sort();
    const yearData = sortedYears.map(year => yearCounts[year]);

    yearChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedYears,
            datasets: [{
                label: 'Number of Cases',
                data: yearData,
                backgroundColor: '#4f46e5',
                borderColor: '#3730a3',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Cases by Year'
                }
            }
        }
    });
}

function renderCourtChart() {
    const ctx = document.getElementById('courtChart').getContext('2d');
    if (courtChart) {
        courtChart.destroy();
    }

    const courtCounts = casesData.reduce((acc, caseItem) => {
        const court = caseItem.court || 'Unknown';
        acc[court] = (acc[court] || 0) + 1;
        return acc;
    }, {});

    // Sort by count, descending, and take top 10
    const sortedCourts = Object.entries(courtCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(entry => entry[0]);

    const courtData = sortedCourts.map(court => courtCounts[court]);

    courtChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedCourts,
            datasets: [{
                label: 'Number of Cases',
                data: courtData,
                backgroundColor: '#10b981',
                borderColor: '#047857',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Top 10 Courts by Case Count'
                }
            }
        }
    });
}

function renderCaseTypeReportChart() {
    const ctx = document.getElementById('caseTypeReportChart').getContext('2d');
    if (caseTypeReportChart) {
        caseTypeReportChart.destroy();
    }

    const caseTypeCounts = casesData.reduce((acc, caseItem) => {
        const caseType = caseItem.caseType || 'Unknown';
        acc[caseType] = (acc[caseType] || 0) + 1;
        return acc;
    }, {});

    // Sort by count, descending, and take top 8
    const sortedCaseTypes = Object.entries(caseTypeCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8)
        .map(entry => entry[0]);

    const caseTypeData = sortedCaseTypes.map(caseType => caseTypeCounts[caseType]);

    caseTypeReportChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: sortedCaseTypes,
            datasets: [{
                data: caseTypeData,
                backgroundColor: [
                    '#4f46e5', '#10b981', '#f59e0b', '#ef4444', 
                    '#8b5cf6', '#06b6d4', '#f97316', '#84cc16'
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Top 8 Case Types'
                }
            }
        }
    });
}

// --- UPCOMING CASES ---
function renderUpcomingCases() {
    const range = parseInt(document.getElementById('upcomingRange').value);
    const today = new Date();
    const futureDate = new Date();
    futureDate.setDate(today.getDate() + range);

    const upcomingCases = casesData.filter(caseItem => {
        if (!caseItem.nextHearing) return false;
        const hearingDate = new Date(caseItem.nextHearing);
        return hearingDate >= today && hearingDate <= futureDate;
    });

    const tableBody = document.getElementById('upcomingBody');
    
    if (upcomingCases.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No upcoming cases in the selected range.</td></tr>';
        return;
    }

    tableBody.innerHTML = upcomingCases.map(caseItem => `
        <tr data-id="${caseItem.id}">
            <td>${caseItem.caseNo || 'N/A'}</td>
            <td>${caseItem.year || 'N/A'}</td>
            <td>${caseItem.court || 'N/A'}</td>
            <td>${caseItem.parties || 'N/A'}</td>
            <td>${formatDate(caseItem.nextHearing)}</td>
            <td>${caseItem.purpose || 'N/A'}</td>
            <td>${caseItem.contact || 'N/A'}</td>
            <td>${caseItem.injunction || 'No'}</td>
            <td>
                <button class="btn btn-sm btn-info btn-view-upcoming" data-id="${caseItem.id}" title="View Details"><i class="fas fa-eye"></i></button>
            </td>
        </tr>
    `).join('');

    document.querySelectorAll('.btn-view-upcoming').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            viewCaseDetails(id);
        });
    });
}

document.getElementById('upcomingRange').addEventListener('change', renderUpcomingCases);
document.getElementById('btnPrintUpcoming').addEventListener('click', () => {
    window.print();
});

// --- DOCUMENTS ---
function renderDocumentsTable(type) {
    const tableBody = document.getElementById(`documentTableBody_${type}`);
    if (!tableBody) return;

    const filteredDocs = documentsData.filter(doc => doc.type === type);
    
    tableBody.innerHTML = '';
    
    if (filteredDocs.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No documents found.</td></tr>';
        return;
    }

    tableBody.innerHTML = filteredDocs.map((doc, index) => `
        <tr data-id="${doc.id}">
            <td>${index + 1}</td>
            <td>${doc.title}</td>
            <td>${formatDate(doc.uploadDate)}</td>
            <td>
                <button class="btn btn-sm btn-info btn-view-doc" data-id="${doc.id}" title="View Details"><i class="fas fa-eye"></i></button>
                <button class="btn btn-sm btn-success btn-download-doc" data-id="${doc.id}" title="Download File"><i class="fas fa-download"></i></button>
                <button class="btn btn-sm btn-danger btn-delete-doc" data-id="${doc.id}" title="Delete Document"><i class="fas fa-trash-alt"></i></button>
            </td>
        </tr>
    `).join('');

    document.querySelectorAll('.btn-view-doc').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            viewDocumentDetails(id);
        });
    });

    document.querySelectorAll('.btn-download-doc').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            downloadDocument(id);
        });
    });

    document.querySelectorAll('.btn-delete-doc').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = parseInt(e.currentTarget.getAttribute('data-id'));
            deleteDocument(id);
        });
    });
}

function setupDocumentForm(type) {
    const form = document.getElementById(`documentForm_${type}`);
    const fileInput = document.getElementById(`docFile_${type}`);
    const fileHelp = document.getElementById(`docFileHelp_${type}`);
    const cancelBtn = document.getElementById(`docCancelBtn_${type}`);
    const saveBtn = document.getElementById(`docSaveBtn_${type}`);

    if (!form) return;

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveDocument(type);
    });

    cancelBtn.addEventListener('click', () => {
        clearDocumentForm(type);
    });

    // Update file help text based on whether we're editing
    form.addEventListener('reset', () => {
        fileHelp.textContent = 'Select a file to upload. (Required for new documents)';
    });
}

async function saveDocument(type) {
    const docId = document.getElementById(`docId_${type}`).value ? parseInt(document.getElementById(`docId_${type}`).value) : null;
    const fileInput = document.getElementById(`docFile_${type}`);
    const file = fileInput.files[0];
    
    // For new documents, require a file
    if (!docId && !file) {
        alert('Please select a file to upload.');
        return;
    }

    const existingDoc = docId ? documentsData.find(d => d.id === docId) : null;
    let fileBase64 = existingDoc ? existingDoc.fileContent : null;
    let fileName = existingDoc ? existingDoc.fileName : null;
    let mimeType = existingDoc ? existingDoc.mimeType : null;

    if (file) {
        fileBase64 = await fileToBase64(file);
        fileName = file.name;
        mimeType = file.type;
    }

    const newDocument = {
        title: document.getElementById(`docName_${type}`).value.trim(),
        type: type,
        fileName: fileName,
        mimeType: mimeType,
        fileContent: fileBase64,
        notes: document.getElementById(`docNote_${type}`).value.trim(),
        uploadDate: existingDoc ? existingDoc.uploadDate : new Date().toISOString().split('T')[0]
    };

    if (docId) {
        newDocument.id = docId;
    }

    try {
        await putData('documents', newDocument);
        clearDocumentForm(type);
        await refreshUI();
        alert(`Document ${docId ? 'updated' : 'uploaded'} successfully!`);
    } catch (error) {
        console.error("Error saving document:", error);
        alert("Failed to save document.");
    }
}

function clearDocumentForm(type) {
    document.getElementById(`documentForm_${type}`).reset();
    document.getElementById(`docId_${type}`).value = '';
    document.getElementById(`docCancelBtn_${type}`).style.display = 'none';
    document.getElementById(`docSaveBtn_${type}`).innerHTML = `<i class="fas fa-upload me-1"></i> Upload ${getDocumentTypeName(type)}`;
}

function getDocumentTypeName(type) {
    switch(type) {
        case 'JUDGEMENT': return 'Judgement';
        case 'LAW': return 'Law File';
        case 'FORM': return 'General File';
        default: return 'Document';
    }
}

function viewDocumentDetails(id) {
    const doc = documentsData.find(d => d.id === id);
    if (!doc) return;

    document.getElementById('modalDocTitle').textContent = doc.title;
    document.getElementById('modalDocType').textContent = getDocumentTypeName(doc.type);
    document.getElementById('modalDocFilename').textContent = doc.fileName || 'N/A';
    document.getElementById('modalDocDate').textContent = formatDate(doc.uploadDate);
    document.getElementById('modalDocNotes').textContent = doc.notes || 'N/A';

    document.getElementById('btnDownloadDocument').onclick = () => {
        downloadDocument(id);
    };

    document.getElementById('btnDeleteDocument').onclick = () => {
        documentDetailModal.hide();
        deleteDocument(id);
    };

    documentDetailModal.show();
}

function downloadDocument(id) {
    const doc = documentsData.find(d => d.id === id);
    if (!doc || !doc.fileContent) {
        alert('Document file not found.');
        return;
    }

    try {
        const link = document.createElement('a');
        link.href = doc.fileContent;
        link.download = doc.fileName || `document_${id}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error("Error downloading document:", error);
        alert("Failed to download document.");
    }
}

async function deleteDocument(id) {
    const doc = documentsData.find(d => d.id === id);
    if (!doc) return;

    if (confirm(`Are you sure you want to delete "${doc.title}"?`)) {
        try {
            await deleteData('documents', id);
            await refreshUI();
            documentDetailModal.hide();
        } catch (error) {
            console.error("Error deleting document:", error);
            alert("Failed to delete document.");
        }
    }
}

// --- COURT & CASE TYPE MANAGEMENT ---
document.getElementById('addCourtBtn').addEventListener('click', () => {
    document.getElementById('courtForm').reset();
    courtModal.show();
});

document.getElementById('removeCourtBtn').addEventListener('click', async () => {
    const selectedCourt = document.getElementById('court').value;
    if (!selectedCourt) {
        alert('Please select a court to remove.');
        return;
    }

    if (confirm(`Are you sure you want to remove "${selectedCourt}" from the courts list?`)) {
        try {
            await deleteData('courts', selectedCourt);
            await refreshUI();
            alert(`Court "${selectedCourt}" removed successfully.`);
        } catch (error) {
            console.error("Error removing court:", error);
            alert("Failed to remove court.");
        }
    }
});

document.getElementById('courtForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const courtName = document.getElementById('courtName').value.trim();
    
    if (!courtName) {
        alert('Please enter a court name.');
        return;
    }

    try {
        await putData('courts', { name: courtName });
        courtModal.hide();
        await refreshUI();
        alert(`Court "${courtName}" added successfully.`);
    } catch (error) {
        console.error("Error adding court:", error);
        alert("Failed to add court.");
    }
});

document.getElementById('addCaseTypeBtn').addEventListener('click', () => {
    document.getElementById('caseTypeForm').reset();
    caseTypeModal.show();
});

document.getElementById('removeCaseTypeBtn').addEventListener('click', async () => {
    const selectedCaseType = document.getElementById('caseType').value;
    if (!selectedCaseType) {
        alert('Please select a case type to remove.');
        return;
    }

    if (confirm(`Are you sure you want to remove "${selectedCaseType}" from the case types list?`)) {
        try {
            await deleteData('caseTypes', selectedCaseType);
            await refreshUI();
            alert(`Case type "${selectedCaseType}" removed successfully.`);
        } catch (error) {
            console.error("Error removing case type:", error);
            alert("Failed to remove case type.");
        }
    }
});

document.getElementById('caseTypeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const caseTypeName = document.getElementById('caseTypeName').value.trim();
    
    if (!caseTypeName) {
        alert('Please enter a case type name.');
        return;
    }

    try {
        await putData('caseTypes', { name: caseTypeName });
        caseTypeModal.hide();
        await refreshUI();
        alert(`Case type "${caseTypeName}" added successfully.`);
    } catch (error) {
        console.error("Error adding case type:", error);
        alert("Failed to add case type.");
    }
});

// --- EXPORT/IMPORT FUNCTIONALITY ---
function exportDataToXLSX() {
    if (casesData.length === 0) {
        alert('No cases to export.');
        return;
    }

    try {
        const worksheet = XLSX.utils.json_to_sheet(casesData.map(caseItem => ({
            'Court': caseItem.court,
            'Case Type': caseItem.caseType,
            'Case No': caseItem.caseNo,
            'Year': caseItem.year,
            'Parties': caseItem.parties,
            'Client Type': caseItem.clientType,
            'Contact': caseItem.contact,
            'Injunction': caseItem.injunction,
            'Priority': caseItem.priority,
            'CNR No': caseItem.cnr,
            'Filing Date': caseItem.filingDate,
            'Next Hearing': caseItem.nextHearing,
            'Status': caseItem.status,
            'Address': caseItem.address,
            'Money History': caseItem.moneyHistory,
            'Linked Case': caseItem.linkedCase ? getCaseTextById(parseInt(caseItem.linkedCase)) : '',
            'Purpose': caseItem.purpose,
            'Advocate Details': caseItem.advocateDetails,
            'Extra Note': caseItem.extraNote,
            'Special Judgement': caseItem.specialJudgement,
            'Details': caseItem.details
        })));

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Cases');
        XLSX.writeFile(workbook, `Case_Manager_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
    } catch (error) {
        console.error("Error exporting to XLSX:", error);
        alert("Failed to export data. Check console for details.");
    }
}

document.getElementById('importXLSXInputCase').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (jsonData.length === 0) {
            alert('No data found in the selected file.');
            return;
        }

        if (confirm(`This will import ${jsonData.length} cases. Continue?`)) {
            for (const item of jsonData) {
                const newCase = {
                    court: item.Court || '',
                    caseType: item['Case Type'] || '',
                    caseNo: item['Case No'] || '',
                    year: item.Year || '',
                    parties: item.Parties || '',
                    clientType: item['Client Type'] || '',
                    contact: item.Contact || '',
                    injunction: item.Injunction || 'No',
                    priority: item.Priority || 'Medium',
                    cnr: item['CNR No'] || '',
                    filingDate: item['Filing Date'] || '',
                    nextHearing: item['Next Hearing'] || '',
                    status: item.Status || 'Active',
                    address: item.Address || '',
                    moneyHistory: item['Money History'] || '',
                    linkedCase: item['Linked Case'] || '',
                    purpose: item.Purpose || '',
                    advocateDetails: item['Advocate Details'] || '',
                    extraNote: item['Extra Note'] || '',
                    specialJudgement: item['Special Judgement'] || '',
                    details: item.Details || '',
                    photo: '',
                    signature: '',
                    documents: [],
                    hearingHistory: [],
                    qrCodeContent: `${item['Case No'] || ''}/${item.Year || ''} - ${item.Parties || ''}`
                };

                await putData('cases', newCase);
            }

            alert(`Successfully imported ${jsonData.length} cases.`);
            await refreshUI();
        }
    } catch (error) {
        console.error("Error importing XLSX:", error);
        alert("Failed to import data. Check console for details.");
    }

    e.target.value = '';
});

document.getElementById('exportTransactionXLSX').addEventListener('click', () => {
    if (transactionsData.length === 0) {
        alert('No transactions to export.');
        return;
    }

    try {
        const worksheet = XLSX.utils.json_to_sheet(transactionsData.map(transaction => ({
            'Date': transaction.date,
            'Type': transaction.type,
            'Amount': transaction.amount,
            'Description': transaction.description
        })));

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Transactions');
        XLSX.writeFile(workbook, `Transaction_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
    } catch (error) {
        console.error("Error exporting transactions to XLSX:", error);
        alert("Failed to export transactions.");
    }
});

// --- BACKUP & RESTORE ---
document.getElementById('exportBackup').addEventListener('click', async () => {
    try {
        const backupData = {
            cases: casesData,
            tasks: tasksData,
            reminders: remindersData,
            whatwork: whatworkData,
            transactions: transactionsData,
            courts: courtsData,
            caseTypes: caseTypesData,
            documents: documentsData,
            exportDate: new Date().toISOString(),
            version: DB_VERSION
        };

        const dataStr = JSON.stringify(backupData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `case_manager_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('Backup exported successfully!');
    } catch (error) {
        console.error("Error exporting backup:", error);
        alert("Failed to export backup.");
    }
});

document.getElementById('importBackupFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        document.getElementById('importBackup').disabled = false;
    }
});

document.getElementById('importBackup').addEventListener('click', async () => {
    const fileInput = document.getElementById('importBackupFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a backup file to import.');
        return;
    }

    if (!confirm('WARNING: This will overwrite all your current data. Are you sure you want to continue?')) {
        return;
    }

    try {
        const fileText = await file.text();
        const backupData = JSON.parse(fileText);

        // Validate backup structure
        if (!backupData.cases || !backupData.tasks || !backupData.reminders || 
            !backupData.whatwork || !backupData.transactions || !backupData.courts || 
            !backupData.caseTypes || !backupData.documents) {
            throw new Error('Invalid backup file format.');
        }

        // Clear existing data
        await clearStore('cases');
        await clearStore('tasks');
        await clearStore('reminders');
        await clearStore('whatwork');
        await clearStore('transactions');
        await clearStore('courts');
        await clearStore('caseTypes');
        await clearStore('documents');

        // Import data
        for (const caseItem of backupData.cases) {
            await putData('cases', caseItem);
        }
        for (const task of backupData.tasks) {
            await putData('tasks', task);
        }
        for (const reminder of backupData.reminders) {
            await putData('reminders', reminder);
        }
        for (const whatwork of backupData.whatwork) {
            await putData('whatwork', whatwork);
        }
        for (const transaction of backupData.transactions) {
            await putData('transactions', transaction);
        }
        for (const court of backupData.courts) {
            await putData('courts', court);
        }
        for (const caseType of backupData.caseTypes) {
            await putData('caseTypes', caseType);
        }
        for (const document of backupData.documents) {
            await putData('documents', document);
        }

        alert('Backup imported successfully!');
        fileInput.value = '';
        document.getElementById('importBackup').disabled = true;
        await refreshUI();
    } catch (error) {
        console.error("Error importing backup:", error);
        alert("Failed to import backup. The file may be corrupted or in an invalid format.");
    }
});

document.getElementById('clearAllData').addEventListener('click', async () => {
    if (!confirm('DANGER: This will PERMANENTLY DELETE ALL YOUR DATA. This action cannot be undone. Are you absolutely sure?')) {
        return;
    }

    if (!confirm('FINAL WARNING: All cases, tasks, reminders, transactions, and settings will be lost forever. Type "DELETE" to confirm.')) {
        return;
    }

    const userInput = prompt('Please type "DELETE" to confirm permanent deletion of all data:');
    if (userInput !== 'DELETE') {
        alert('Data deletion cancelled.');
        return;
    }

    try {
        await clearStore('cases');
        await clearStore('tasks');
        await clearStore('reminders');
        await clearStore('whatwork');
        await clearStore('transactions');
        await clearStore('courts');
        await clearStore('caseTypes');
        await clearStore('documents');

        alert('All data has been permanently deleted.');
        await refreshUI();
    } catch (error) {
        console.error("Error clearing data:", error);
        alert("Failed to clear data.");
    }
});

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Initialize database
        await initDB();
        
        // Initialize Bootstrap modals
        caseDetailModal = new bootstrap.Modal(document.getElementById('caseDetailModal'));
        previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        dayEventsModal = new bootstrap.Modal(document.getElementById('dayEventsModal'));
        taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
        taskDetailModal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
        reminderModal = new bootstrap.Modal(document.getElementById('reminderModal'));
        courtModal = new bootstrap.Modal(document.getElementById('courtModal'));
        caseTypeModal = new bootstrap.Modal(document.getElementById('caseTypeModal'));
        documentDetailModal = new bootstrap.Modal(document.getElementById('documentDetailModal'));

        // Load all data and refresh UI
        await refreshUI();
        
        // Set up document forms
        setupDocumentForm('JUDGEMENT');
        setupDocumentForm('LAW');
        setupDocumentForm('FORM');
        
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('nextHearing').value = today;
        document.getElementById('filingDate').value = today;
        document.getElementById('taskDate').value = today;
        document.getElementById('reminderDate').value = today;
        document.getElementById('whatworkDate').value = today;
        document.getElementById('transactionDate').value = today;
        
        // Set up refresh button
        document.getElementById('btnRefresh').addEventListener('click', async () => {
            await refreshUI();
            alert('Data refreshed successfully!');
        });
        
        console.log('Case Manager initialized successfully.');
    } catch (error) {
        console.error('Failed to initialize Case Manager:', error);
        alert('Error initializing application. Check console for details.');
    }
});
</script>
</body>
</html>
